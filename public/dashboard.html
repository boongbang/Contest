<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COSS - 대시보드</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* 공통 스타일 (나중에 style.css로 분리 가능) */
        :root { --primary: #4F46E5; --bg: #F3F4F6; --card-bg: #FFFFFF; }
        body { background: var(--bg); margin: 0; padding-bottom: 80px; font-family: 'Pretendard', sans-serif; }
        
        .header { background: var(--primary); padding: 30px 20px 50px; color: white; border-radius: 0 0 30px 30px; }
        .welcome { font-size: 14px; opacity: 0.9; }
        .user-name { font-size: 24px; font-weight: 700; margin-top: 5px; }

        .container { padding: 0 20px; margin-top: -30px; }
        
        .card { background: var(--card-bg); border-radius: 20px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .card-title { font-weight: 700; font-size: 16px; color: #1F2937; }
        
        /* 상태 카드 */
        .status-card { display: flex; align-items: center; justify-content: space-between; }
        .status-icon { width: 50px; height: 50px; background: #EEF2FF; border-radius: 15px; display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 24px; }
        .status-info { flex: 1; margin-left: 15px; }
        .status-label { font-size: 12px; color: #6B7280; }
        .status-value { font-size: 18px; font-weight: 700; color: #111827; }
        .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .badge-good { background: #D1FAE5; color: #065F46; }
        .badge-bad { background: #FEE2E2; color: #991B1B; }

        /* 하단 네비게이션 */
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: white; padding: 15px 0; display: flex; justify-content: space-around; border-top: 1px solid #E5E7EB; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); z-index: 100; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #9CA3AF; text-decoration: none; font-size: 12px; cursor: pointer; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 20px; margin-bottom: 5px; }
    </style>
</head>
<body>
    <div class="header">
        <div class="welcome">오늘도 건강하게,</div>
        <div class="user-name"><span id="uName">사용자</span>님</div>
    </div>

    <div class="container">
        <div class="card status-card">
            <div class="status-icon"><i class="fa-solid fa-wifi"></i></div>
            <div class="status-info">
                <div class="status-label">현재 약통 상태</div>
                <div class="status-value" id="sensorStatus">연결 확인 중...</div>
            </div>
            <span class="status-badge" id="connBadge">...</span>
        </div>

        <div class="card">
            <div class="card-header">
                <span class="card-title">오늘의 복약 달성률</span>
                <span style="font-size:12px; color:#6B7280" id="todayDate">11월 24일</span>
            </div>
            <div style="position: relative; height: 200px; display: flex; justify-content: center;">
                <canvas id="todayChart"></canvas>
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                    <div style="font-size: 24px; font-weight: bold;" id="percentText">0%</div>
                    <div style="font-size: 12px; color: #6B7280;">달성</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <span class="card-title">주간 복약 추이</span>
            </div>
            <canvas id="weekChart" height="200"></canvas>
        </div>
    </div>

    <nav class="nav-bar">
        <a href="dashboard.html" class="nav-item active">
            <i class="fa-solid fa-house"></i>홈
        </a>
        <a href="schedule.html" class="nav-item">
            <i class="fa-regular fa-clock"></i>일정
        </a>
        <a href="report.html" class="nav-item">
            <i class="fa-solid fa-chart-pie"></i>리포트
        </a>
        <a href="settings.html" class="nav-item">
            <i class="fa-solid fa-gear"></i>설정
        </a>
    </nav>

    <script>
        const SERVER = 'https://port-0-coss-mi0kk25df8c7e306.sel3.cloudtype.app';
        const token = localStorage.getItem('coss_token');
        const user = JSON.parse(localStorage.getItem('coss_user') || '{}');

        if(!token) location.href = 'index.html';
        document.getElementById('uName').innerText = user.name || '사용자';
        document.getElementById('todayDate').innerText = new Date().toLocaleDateString();

        // 차트 초기화 및 데이터 로드
        async function loadData() {
            try {
                // 1. 센서 값 조회
                const sRes = await fetch(SERVER + '/value');
                const sData = await sRes.json();
                const statusDiv = document.getElementById('sensorStatus');
                const badge = document.getElementById('connBadge');
                
                if(sData.a === 0) {
                    statusDiv.innerText = '보관 중 (안전)';
                    badge.className = 'status-badge badge-good';
                    badge.innerText = 'OK';
                } else {
                    statusDiv.innerText = '복약 중 / 이탈';
                    badge.className = 'status-badge badge-bad';
                    badge.innerText = 'Active';
                }

                // 2. 복약 기록 및 통계 (Dummy Logic for UI demo - 실제론 API 연동)
                // 실제 구현 시 /api/medication-logs 와 /api/schedule 을 비교해야 함.
                updateCharts(75, [1, 1, 0, 1, 1, 1, 0]); // 예시 데이터

            } catch(e) { console.error(e); }
        }

        function updateCharts(todayPercent, weekData) {
            // 도넛 차트
            new Chart(document.getElementById('todayChart'), {
                type: 'doughnut',
                data: {
                    labels: ['복용', '미복용'],
                    datasets: [{
                        data: [todayPercent, 100-todayPercent],
                        backgroundColor: ['#4F46E5', '#E5E7EB'],
                        borderWidth: 0,
                        cutout: '75%'
                    }]
                },
                options: { plugins: { legend: { display: false } } }
            });
            document.getElementById('percentText').innerText = todayPercent + '%';

            // 바 차트
            new Chart(document.getElementById('weekChart'), {
                type: 'bar',
                data: {
                    labels: ['월', '화', '수', '목', '금', '토', '일'],
                    datasets: [{
                        label: '복약 횟수',
                        data: weekData,
                        backgroundColor: '#818CF8',
                        borderRadius: 5
                    }]
                },
                options: {
                    scales: { y: { beginAtZero: true, display: false }, x: { grid: { display: false } } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        setInterval(loadData, 2000); // 2초마다 갱신
        loadData();
    </script>
</body>
</html>
