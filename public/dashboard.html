<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>COSS Dashboard</title>
    
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            /* 테마 색상 (점진적으로 어두워짐) */
            --bg-morning: #6B8E6B;
            --bg-lunch: #537053;
            --bg-dinner: #3c523c;
            --bg-bed: #253325;
            
            --app-bg: #6B8E6B; /* 기본 배경 */
            --sidebar-bg: #f5f6fa;
            --text-dark: #1a1a1a;
            --text-gray: #666666;
            --card-bg: #ffffff;
            --accent-light: #E8F5E9;
            
            --curve-radius: 35px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
        }

        body {
            background-color: #eef1f4;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text-dark);
        }

        .app-wrapper {
            width: 100%;
            height: 100vh;
            background-color: var(--app-bg);
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.3s;
        }

        @media (min-width: 481px) {
            .app-wrapper {
                width: 414px;
                height: 880px;
                border-radius: 40px;
                box-shadow: 0 30px 60px rgba(0,0,0,0.2);
            }
        }

        /* === 헤더 === */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 40px 25px 20px 25px;
            z-index: 20;
            color: #fff;
        }

        .header-title {
            font-size: 1.4rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 8px;
            letter-spacing: -0.5px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        /* 센서 상태 */
        .sensor-status {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(0,0,0,0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
            backdrop-filter: blur(4px);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .status-dot.active { background-color: #4CAF50; box-shadow: 0 0 8px #4CAF50; }
        .status-dot.inactive { background-color: #F44336; }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }

        .user-profile-icon {
            width: 36px;
            height: 36px;
            background: rgba(255,255,255,0.25);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #fff;
        }

        /* === 사이드바 & 메인 === */
        .content-body {
            display: flex;
            flex: 1;
            height: 100%;
            overflow: hidden;
        }

        .sidebar-container {
            width: 80px;
            background-color: transparent;
            display: flex;
            flex-direction: column;
            height: 100%;
            padding-top: 20px;
            border-top-right-radius: var(--curve-radius);
            position: relative;
            overflow: hidden;
        }

        .active-indicator {
            position: absolute;
            left: 0;
            top: 20px;
            width: 100%;
            height: 80px;
            background: transparent;
            z-index: 0;
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
        }
        .active-indicator::before, .active-indicator::after {
            content: '';
            position: absolute;
            right: 0;
            width: 100%;
            height: 100vh;
            background-color: var(--sidebar-bg);
        }
        .active-indicator::before { bottom: 100%; border-bottom-right-radius: var(--curve-radius); }
        .active-indicator::after { top: 100%; border-top-right-radius: var(--curve-radius); }
        .active-indicator.is-first::before { opacity: 0; }

        .sidebar-item {
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
            z-index: 1;
        }
        .icon-box {
            width: 40px;
            height: 40px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            color: rgba(255,255,255,0.7);
            transition: 0.3s;
        }
        .sidebar-item.active .icon-box {
            background: #fff;
            color: var(--app-bg);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        /* 메인 컨텐츠 */
        .main-content {
            flex: 1;
            padding: 0 20px 30px 10px;
            overflow-y: auto;
            background: var(--sidebar-bg);
            border-top-left-radius: var(--curve-radius);
            border-bottom-left-radius: var(--curve-radius);
        }
        .main-content::-webkit-scrollbar { display: none; }

        .page-section { display: none; animation: fadeUp 0.4s ease-out forwards; }
        .page-section.active { display: block; }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .welcome-text { margin: 25px 0 20px 5px; }
        .welcome-text h2 { font-size: 1.6rem; font-weight: 700; color: var(--text-dark); letter-spacing: -0.5px; }
        .welcome-text p { font-size: 0.9rem; color: var(--text-gray); margin-top: 4px; }

        /* === 센서 카드 (큰 카드) === */
        .sensor-card {
            background: var(--app-bg-dark);
            border-radius: 24px;
            padding: 24px;
            color: white;
            margin-bottom: 20px;
            box-shadow: 0 15px 30px rgba(107, 142, 107, 0.2);
            position: relative;
            overflow: hidden;
        }
        .sensor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; opacity: 0.9; }
        .sensor-big-value { font-size: 2.8rem; font-weight: 800; margin: 10px 0; letter-spacing: -1px; }
        .sensor-state { 
            display: inline-flex; align-items: center; gap: 6px; 
            padding: 6px 14px; border-radius: 20px; 
            font-size: 0.85rem; font-weight: 600; 
            background: rgba(255,255,255,0.15); 
        }
        .sensor-state.detected { background: rgba(255, 82, 82, 0.2); color: #ffcdd2; }
        .sensor-state.clear { background: rgba(105, 240, 174, 0.2); color: #b9f6ca; }

        /* === 복약 카드 (4분할 Grid) - UI 전면 개선 === */
        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 14px;
            margin-bottom: 25px;
        }

        .med-status-card {
            background: #fff;
            border-radius: 22px;
            padding: 18px;
            height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            position: relative;
            box-shadow: 0 8px 20px rgba(0,0,0,0.04);
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid transparent;
        }
        .med-status-card:hover { transform: translateY(-2px); box-shadow: 0 12px 25px rgba(0,0,0,0.08); }

        /* 복용 완료 스타일 */
        .med-status-card.taken {
            background: #F1F8E9; /* 아주 연한 녹색 */
            border-color: var(--app-bg);
        }

        /* 심플한 원형 점 (Circle) */
        .status-circle {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            position: absolute;
            top: 18px;
            right: 18px;
            flex-shrink: 0; /* 찌그러짐 방지 */
        }
        
        /* 시간대별 원 색상 */
        .med-status-card[data-id="1"] .status-circle { background: var(--bg-morning); }
        .med-status-card[data-id="2"] .status-circle { background: var(--bg-lunch); }
        .med-status-card[data-id="3"] .status-circle { background: var(--bg-dinner); }
        .med-status-card[data-id="4"] .status-circle { background: var(--bg-bed); }

        .card-content { text-align: left; } /* 좌측 정렬 */
        
        .card-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 2px;
        }
        
        .card-desc {
            font-size: 0.75rem;
            color: #888;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 80%;
        }

        /* 시간 표시 버튼 (입력창 대신 커스텀 UI) */
        .card-time-btn {
            background: #f4f4f6;
            color: var(--text-dark);
            border: none;
            border-radius: 12px;
            padding: 8px 12px;
            font-size: 1.1rem; /* 글씨 크기 조정 */
            font-weight: 700;
            width: 100%;
            text-align: left; /* 좌측 정렬 */
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .card-time-btn:hover { background: #eaeaec; }
        .card-time-btn::after {
            content: '\f017'; /* 시계 아이콘 */
            font-family: "Font Awesome 6 Free";
            font-weight: 400;
            font-size: 0.8rem;
            color: #bbb;
        }

        /* 복용 완료 시 텍스트 */
        .taken-badge {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--app-bg);
            background: rgba(107, 142, 107, 0.15);
            padding: 6px 10px;
            border-radius: 10px;
            display: inline-block;
            margin-top: auto;
        }

        /* === 커스텀 시간 설정 모달 (콤보박스 대체) === */
        .time-modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(3px);
        }
        .time-modal-overlay.show { display: flex; }

        .time-modal {
            background: #fff;
            width: 320px;
            border-radius: 24px;
            padding: 25px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            text-align: center;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .time-modal h3 { font-size: 1.2rem; font-weight: 700; margin-bottom: 20px; color: var(--text-dark); }

        .time-picker-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 25px;
        }
        
        .time-column { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .time-value { 
            font-size: 2.5rem; font-weight: 800; color: var(--app-bg); 
            width: 70px; text-align: center; 
            font-variant-numeric: tabular-nums;
        }
        .time-btn {
            width: 40px; height: 30px;
            border: none; background: #f0f0f0; border-radius: 8px;
            color: #666; cursor: pointer; font-size: 1rem;
            transition: 0.2s;
        }
        .time-btn:hover { background: #e0e0e0; }
        .time-colon { font-size: 2rem; font-weight: 700; color: #ccc; margin-top: -5px; }

        .modal-actions { display: flex; gap: 10px; }
        .modal-btn {
            flex: 1; padding: 12px; border-radius: 12px; border: none;
            font-weight: 600; cursor: pointer; font-size: 1rem;
        }
        .btn-cancel { background: #f5f6fa; color: #666; }
        .btn-save { background: var(--app-bg); color: #fff; }

        /* 알림 배너 */
        .alarm-banner {
            position: fixed; top: -80px; left: 0; right: 0;
            background: rgba(255, 82, 82, 0.95);
            color: white; padding: 15px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            z-index: 4000; transition: top 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 5px 15px rgba(255, 82, 82, 0.3);
            border-bottom-left-radius: 20px; border-bottom-right-radius: 20px;
        }
        .alarm-banner.show { top: 0; }

        /* 기타 리스트 스타일 (약물관리 등) */
        .list-card { background: white; border-radius: 20px; padding: 20px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.03); }
        .list-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 12px; margin-bottom: 8px; background: #f9f9f9; border-radius: 12px; 
        }
        
        .loading-overlay {
            display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.8); z-index: 2000;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner { width: 40px; height: 40px; border: 3px solid #ddd; border-top: 3px solid var(--app-bg); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <div class="alarm-banner" id="alarmBanner">
            <i class="fa-solid fa-bell fa-shake"></i>
            <span id="alarmMessage" style="font-weight:600;">약 드실 시간입니다!</span>
            <button onclick="stopAlarm()" style="background:white; color:#ff5252; border:none; border-radius:20px; padding:5px 12px; font-weight:bold; margin-left:10px; cursor:pointer;">확인</button>
        </div>
        <audio id="alarmSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" loop></audio>

        <div class="time-modal-overlay" id="timeModal">
            <div class="time-modal">
                <h3>시간 설정</h3>
                <div class="time-picker-container">
                    <div class="time-column">
                        <button class="time-btn" onclick="adjustTime('hour', 1)"><i class="fa-solid fa-chevron-up"></i></button>
                        <div class="time-value" id="modalHour">08</div>
                        <button class="time-btn" onclick="adjustTime('hour', -1)"><i class="fa-solid fa-chevron-down"></i></button>
                    </div>
                    <div class="time-colon">:</div>
                    <div class="time-column">
                        <button class="time-btn" onclick="adjustTime('minute', 10)"><i class="fa-solid fa-chevron-up"></i></button>
                        <div class="time-value" id="modalMinute">00</div>
                        <button class="time-btn" onclick="adjustTime('minute', -10)"><i class="fa-solid fa-chevron-down"></i></button>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="modal-btn btn-cancel" onclick="closeTimeModal()">취소</button>
                    <button class="modal-btn btn-save" onclick="saveTime()">저장</button>
                </div>
            </div>
        </div>

        <div class="loading-overlay" id="loadingOverlay">
            <div class="spinner"></div>
        </div>

        <div class="header">
            <div class="header-title"><i class="fa-solid fa-pills"></i> COSS</div>
            <div class="header-actions">
                <div class="sensor-status">
                    <div class="status-dot" id="sensorStatusDot"></div>
                    <span id="sensorStatusText">연결중</span>
                </div>
                <div class="user-profile-icon" onclick="logout()">
                    <i class="fa-solid fa-right-from-bracket"></i>
                </div>
            </div>
        </div>

        <div class="content-body">
            <div class="sidebar-container">
                <div class="active-indicator"></div>
                <div class="sidebar-item active" data-section="dashboard" onclick="switchSection('dashboard')">
                    <div class="icon-box"><i class="fa-solid fa-chart-pie"></i></div>
                </div>
                <div class="sidebar-item" data-section="medication" onclick="switchSection('medication')">
                    <div class="icon-box"><i class="fa-solid fa-capsules"></i></div>
                </div>
                <div class="sidebar-item" data-section="reminder" onclick="switchSection('reminder')">
                    <div class="icon-box"><i class="fa-regular fa-bell"></i></div>
                </div>
                <div class="sidebar-item" data-section="profile" onclick="switchSection('profile')">
                    <div class="icon-box"><i class="fa-solid fa-user"></i></div>
                </div>
            </div>

            <div class="main-content">
                <section class="page-section active" id="dashboardSection">
                    <div class="welcome-text">
                        <h2>안녕하세요, <span id="userName">User</span>님</h2>
                        <p>오늘의 복약 일정을 확인하세요.</p>
                    </div>

                    <div class="sensor-card">
                        <div class="sensor-header">
                            <span>IR 센서 상태</span>
                            <i class="fa-solid fa-wifi"></i>
                        </div>
                        <div id="sensorDataArea">
                            <div style="text-align:center; padding:20px; opacity:0.7;">데이터 로딩중...</div>
                        </div>
                    </div>

                    <div class="summary-grid">
                        <div class="med-status-card" id="medCard-1" data-id="1">
                            <div class="status-circle"></div>
                            <div class="card-content">
                                <div class="card-title">아침 약</div>
                                <div class="card-desc" id="medDesc-1">로딩중...</div>
                            </div>
                            <div id="timeWrapper-1">
                                <button class="card-time-btn" id="timeBtn-1" onclick="openTimePicker(1)">08:00</button>
                            </div>
                        </div>

                        <div class="med-status-card" id="medCard-2" data-id="2">
                            <div class="status-circle"></div>
                            <div class="card-content">
                                <div class="card-title">점심 약</div>
                                <div class="card-desc" id="medDesc-2">로딩중...</div>
                            </div>
                            <div id="timeWrapper-2">
                                <button class="card-time-btn" id="timeBtn-2" onclick="openTimePicker(2)">13:00</button>
                            </div>
                        </div>

                        <div class="med-status-card" id="medCard-3" data-id="3">
                            <div class="status-circle"></div>
                            <div class="card-content">
                                <div class="card-title">저녁 약</div>
                                <div class="card-desc" id="medDesc-3">로딩중...</div>
                            </div>
                            <div id="timeWrapper-3">
                                <button class="card-time-btn" id="timeBtn-3" onclick="openTimePicker(3)">18:00</button>
                            </div>
                        </div>

                        <div class="med-status-card" id="medCard-4" data-id="4">
                            <div class="status-circle"></div>
                            <div class="card-content">
                                <div class="card-title">자기전</div>
                                <div class="card-desc" id="medDesc-4">로딩중...</div>
                            </div>
                            <div id="timeWrapper-4">
                                <button class="card-time-btn" id="timeBtn-4" onclick="openTimePicker(4)">22:00</button>
                            </div>
                        </div>
                    </div>

                    <div class="list-card">
                        <canvas id="weeklyChart" height="200"></canvas>
                    </div>
                </section>

                <section class="page-section" id="medicationSection">
                    <div class="welcome-text"><h2>약물 관리</h2></div>
                    <div class="list-card" id="medicationListArea"></div>
                </section>

                <section class="page-section" id="reminderSection">
                    <div class="welcome-text"><h2>알림 설정</h2></div>
                    <div class="list-card" id="reminderListArea"></div>
                </section>

                <section class="page-section" id="profileSection">
                    <div class="list-card" style="text-align:center;">
                        <div class="user-profile-icon" style="width:80px; height:80px; margin:0 auto 15px; background:#eef1f4; color:#999; font-size:2rem;">
                            <i class="fa-solid fa-user"></i>
                        </div>
                        <h3 id="profileName">User</h3>
                        <p id="profileEmail" style="color:#999; margin-bottom:20px;">email@example.com</p>
                        <button style="background:var(--app-bg); color:white; border:none; padding:12px 30px; border-radius:15px; font-weight:bold;" onclick="exportData()">데이터 내보내기</button>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        let authToken = null;
        let sensorCheckInterval = null;
        let alarmCheckInterval = null;
        let isAlarmPlaying = false;
        
        // 시간 설정 모달 관련 변수
        let currentEditId = null;
        let tempHour = 8;
        let tempMinute = 0;

        window.addEventListener('load', () => {
            authToken = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
            const userInfoStr = localStorage.getItem('userInfo');
            
            if (!authToken || !userInfoStr) {
                window.location.href = '/index.html';
                return;
            }
            
            const userInfo = JSON.parse(userInfoStr);
            document.getElementById('userName').textContent = userInfo.name;
            document.getElementById('profileName').textContent = userInfo.name;
            document.getElementById('profileEmail').textContent = userInfo.email;
            
            loadDashboardData();
            
            sensorCheckInterval = setInterval(checkSensorStatus, 1000);
            checkSensorStatus();
            
            alarmCheckInterval = setInterval(checkAlarmLogic, 10000);
            checkAlarmLogic();

            // 사이드바 초기화
            moveIndicator(0);
        });

        // === 커스텀 시간 설정 모달 로직 ===
        function openTimePicker(id) {
            currentEditId = id;
            const btn = document.getElementById(`timeBtn-${id}`);
            const [h, m] = btn.textContent.split(':').map(Number);
            tempHour = h;
            tempMinute = m;
            updateModalDisplay();
            document.getElementById('timeModal').classList.add('show');
        }

        function closeTimeModal() {
            document.getElementById('timeModal').classList.remove('show');
        }

        function adjustTime(type, amount) {
            if (type === 'hour') {
                tempHour = (tempHour + amount + 24) % 24;
            } else {
                tempMinute = (tempMinute + amount + 60) % 60;
            }
            updateModalDisplay();
        }

        function updateModalDisplay() {
            document.getElementById('modalHour').textContent = String(tempHour).padStart(2, '0');
            document.getElementById('modalMinute').textContent = String(tempMinute).padStart(2, '0');
        }

        function saveTime() {
            if (currentEditId) {
                const newTime = `${String(tempHour).padStart(2, '0')}:${String(tempMinute).padStart(2, '0')}`;
                document.getElementById(`timeBtn-${currentEditId}`).textContent = newTime;
                
                // 여기서 서버로 시간 업데이트 요청을 보낼 수 있음
                console.log(`Saved time for ID ${currentEditId}: ${newTime}`);
                
                closeTimeModal();
            }
        }

        // === 알람 로직 (±5분) ===
        function checkAlarmLogic() {
            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();

            for (let i = 1; i <= 4; i++) {
                const btn = document.getElementById(`timeBtn-${i}`);
                const card = document.getElementById(`medCard-${i}`);
                
                if (card.classList.contains('taken')) continue; // 이미 복용했으면 패스

                if (btn) {
                    const [h, m] = btn.textContent.split(':').map(Number);
                    const targetMinutes = h * 60 + m;
                    const diff = Math.abs(currentMinutes - targetMinutes);

                    if (diff <= 5 && !isAlarmPlaying) {
                        playAlarm(`${btn.textContent} 복용 시간입니다!`);
                        break;
                    }
                }
            }
        }

        function playAlarm(msg) {
            const audio = document.getElementById('alarmSound');
            document.getElementById('alarmMessage').textContent = msg;
            document.getElementById('alarmBanner').classList.add('show');
            audio.play().catch(e => console.log("Autoplay blocked"));
            isAlarmPlaying = true;
        }

        function stopAlarm() {
            const audio = document.getElementById('alarmSound');
            audio.pause();
            audio.currentTime = 0;
            document.getElementById('alarmBanner').classList.remove('show');
            isAlarmPlaying = false;
        }

        // === 데이터 로드 및 UI 업데이트 ===
        async function loadDashboardData() {
            try {
                const response = await fetch(`${API_URL}/api/dashboard/stats`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json();
                
                if (data.sensors) {
                    updateCards(data.sensors);
                    renderLists(data.sensors);
                }
                if (data.weekly) updateChart(data.weekly);
            } catch (error) {
                console.error(error);
            }
        }

        function updateCards(sensors) {
            for (let i = 1; i <= 4; i++) {
                const s = sensors[i];
                if (!s) continue;

                const card = document.getElementById(`medCard-${i}`);
                const desc = document.getElementById(`medDesc-${i}`);
                const wrapper = document.getElementById(`timeWrapper-${i}`);
                const btn = document.getElementById(`timeBtn-${i}`);

                desc.textContent = s.description || s.name;

                if (s.todayOpened) {
                    card.classList.add('taken');
                    // 복용 완료 시 시간과 날짜 표시
                    const d = new Date(s.lastOpened);
                    const dateStr = `${d.getMonth()+1}/${d.getDate()}`;
                    const timeStr = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                    wrapper.innerHTML = `<div class="taken-badge">${dateStr} ${timeStr} 복용</div>`;
                } else {
                    card.classList.remove('taken');
                    // 대기 중일 땐 버튼 유지, 서버 시간으로 초기화 (최초 1회 또는 필요시)
                    if(btn && !btn.getAttribute('data-touched')) {
                       btn.textContent = s.targetTime || '00:00';
                    }
                }
            }
        }

        function renderLists(sensors) {
            const list = document.getElementById('medicationListArea');
            let html = '';
            Object.values(sensors).forEach(s => {
                html += `<div class="list-item">
                    <div style="font-weight:bold; display:flex; align-items:center; gap:10px;">
                        <div style="width:10px; height:10px; border-radius:50%; background:var(--app-bg);"></div>
                        ${s.name}
                    </div>
                    <div style="color:#888; font-size:0.9rem;">${s.description}</div>
                </div>`;
            });
            list.innerHTML = html;
        }

        // === 센서 상태 (아두이노) ===
        async function checkSensorStatus() {
            try {
                const res = await fetch(`${API_URL}/value`);
                const sensors = await res.json();
                let target = null;
                
                // 켜진(빠진) 센서 찾기
                for(let id in sensors) {
                    if(sensors[id].value === 1) { target = sensors[id]; break; }
                }
                // 없으면 1번 센서 정보라도 보여주기 (대기중)
                if(!target) target = sensors[1];

                const area = document.getElementById('sensorDataArea');
                const dot = document.getElementById('sensorStatusDot');
                const txt = document.getElementById('sensorStatusText');

                const isOpen = target.value === 1;
                
                if(isOpen) {
                    dot.className = 'status-dot active';
                    txt.textContent = '감지됨';
                    area.innerHTML = `
                        <div class="sensor-big-value">ON</div>
                        <div class="sensor-state detected"><i class="fa-solid fa-box-open"></i> ${target.name} 복용중</div>
                    `;
                } else {
                    dot.className = 'status-dot inactive';
                    txt.textContent = '대기중';
                    area.innerHTML = `
                        <div class="sensor-big-value">OFF</div>
                        <div class="sensor-state clear"><i class="fa-solid fa-box"></i> 보관중</div>
                    `;
                }
            } catch (e) { console.error(e); }
        }

        function updateChart(data) {
            const ctx = document.getElementById('weeklyChart').getContext('2d');
            if(weeklyChart) weeklyChart.destroy();
            
            window.weeklyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d.day),
                    datasets: [{
                        label: '복용 횟수',
                        data: data.map(d => d.completedCount || d.count),
                        backgroundColor: '#6B8E6B',
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { display:false } }, x: { grid: { display:false } } }
                }
            });
        }

        // === UI 유틸리티 ===
        function switchSection(section) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`${section}Section`).classList.add('active');
            
            const items = document.querySelectorAll('.sidebar-item');
            items.forEach((el, idx) => {
                el.classList.remove('active');
                if(el.dataset.section === section) {
                    el.classList.add('active');
                    moveIndicator(idx);
                }
            });
        }

        function moveIndicator(index) {
            const indicator = document.querySelector('.active-indicator');
            indicator.style.transform = `translateY(${index * 80}px)`;
            if (index === 0) indicator.classList.add('is-first');
            else indicator.classList.remove('is-first');
        }

        function logout() {
            localStorage.clear();
            sessionStorage.clear();
            window.location.href = '/index.html';
        }
        
        function exportData() { alert('데이터 다운로드 시작'); }
    </script>
</body>
</html>
