<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>COSS - 스마트 약통 관리</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- 1. 디자인 시스템 변수 (Florest 테마) --- */
        :root {
            --app-bg: #6B8E6B;       /* 메인 녹색 배경 */
            --app-bg-dark: #556b57;  /* 어두운 녹색 */
            --sidebar-bg: #f5f6fa;   /* 사이드바 배경 (밝은 회색) */
            --card-bg: #ffffff;      /* 카드 배경 */
            --text-light: #F1F5EF;   /* 어두운 배경 위 텍스트 */
            --text-dark: #333333;    /* 밝은 배경 위 텍스트 */
            --accent-color: #E8F5E9; /* 강조 색상 */
            --curve-radius: 40px;    /* 사이드바 곡률 */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #eef1f4; /* PC 전체 배경 */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        /* --- 2. 앱 래퍼 (반응형 컨테이너) --- */
        .app-wrapper {
            width: 100%;
            height: 100vh;
            background-color: var(--app-bg);
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: background-color 0.3s;
        }

        /* PC 화면: 모바일 앱처럼 중앙 정렬 */
        @media (min-width: 481px) {
            .app-wrapper {
                width: 414px; /* iPhone Max 폭 */
                height: 880px;
                border-radius: 40px;
                box-shadow: 0 30px 60px rgba(0,0,0,0.2);
            }
        }

        /* --- 3. 헤더 영역 --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 40px 30px 20px 30px;
            z-index: 20;
            color: var(--text-light);
        }

        .header-title {
            font-family: 'Merriweather', serif;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-profile-icon {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            cursor: pointer;
            position: relative;
        }

        .notification-badge {
            position: absolute;
            top: 0;
            right: 0;
            width: 12px;
            height: 12px;
            background-color: #ff6b6b;
            border-radius: 50%;
            border: 2px solid var(--app-bg);
        }

        /* --- 4. 메인 레이아웃 (사이드바 + 콘텐츠) --- */
        .content-body {
            display: flex;
            flex: 1;
            height: 100%;
            overflow: hidden;
        }

        /* === 사이드바 (Liquid Effect) === */
        .sidebar-container {
            width: 90px;
            background-color: transparent;
            display: flex;
            flex-direction: column;
            height: 100%;
            padding-bottom: 20px;
            padding-top: 10px;
        }

        .sidebar-item {
            height: 90px;
            background-color: var(--sidebar-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: #999;
        }

        .icon-box {
            width: 45px;
            height: 45px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s;
            background: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        /* Active 상태 로직 (Florest 스타일) */
        .sidebar-item.active {
            background-color: transparent; /* 배경 투명 -> 뒤의 녹색 보임 */
            color: var(--text-light);
            cursor: default;
        }

        .sidebar-item.active .icon-box {
            background: var(--text-light);
            color: var(--app-bg);
            transform: scale(1.1);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        /* 모서리 깎기 효과 */
        .sidebar-item.prev-active { border-bottom-right-radius: var(--curve-radius); }
        .sidebar-item.next-active { border-top-right-radius: var(--curve-radius); }

        .sidebar-filler {
            flex: 1;
            background-color: var(--sidebar-bg);
        }
        .sidebar-filler.next-active { border-top-right-radius: var(--curve-radius); }

        /* === 메인 콘텐츠 영역 === */
        .main-content {
            flex: 1;
            padding: 0 25px 30px 10px;
            overflow-y: auto;
            -ms-overflow-style: none; /* 스크롤바 숨김 */
            scrollbar-width: none;
        }
        .main-content::-webkit-scrollbar { display: none; }

        /* 대시보드 위젯 스타일 */
        .welcome-text {
            color: var(--text-light);
            margin-bottom: 25px;
            animation: fadeInUp 0.5s forwards;
        }
        .welcome-text h2 { font-family: 'Merriweather', serif; font-size: 1.8rem; }
        .welcome-text p { font-size: 0.9rem; opacity: 0.8; }

        /* 요약 카드 그리드 */
        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 25px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 140px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-3px); }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            margin-bottom: 10px;
        }
        .stat-icon.green { background: #E8F5E9; color: #2E7D32; }
        .stat-icon.orange { background: #FFF3E0; color: #EF6C00; }

        .stat-value { font-size: 1.6rem; font-weight: 700; color: var(--text-dark); }
        .stat-label { font-size: 0.8rem; color: #666; font-weight: 500; }

        /* 긴 카드 (다음 복약) */
        .next-dose-card {
            background: var(--app-bg-dark);
            border-radius: 25px;
            padding: 25px;
            color: white;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }
        
        /* 배경 장식 원 */
        .next-dose-card::after {
            content: '';
            position: absolute;
            right: -20px;
            bottom: -20px;
            width: 100px;
            height: 100px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }

        .dose-info h3 { font-size: 0.9rem; opacity: 0.8; margin-bottom: 5px; font-weight: 400; }
        .dose-info .time { font-size: 2rem; font-weight: 700; font-family: 'Merriweather', serif; }
        .dose-info .med-name { font-size: 0.9rem; margin-top: 5px; display: flex; align-items: center; gap: 5px; }
        
        .dose-action {
            background: white;
            color: var(--app-bg-dark);
            width: 50px;
            height: 50px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 2;
        }

        /* 차트 섹션 */
        .chart-section {
            background: white;
            border-radius: 30px 30px 0 0; /* 위쪽만 둥글게 */
            padding: 25px;
            margin: 0 -10px -30px -10px; /* 좌우 하단 여백 제거하여 꽉 채우기 */
            min-height: 250px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .section-title { font-size: 1.1rem; font-weight: 600; color: var(--text-dark); }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

    </style>
</head>
<body>

    <div class="app-wrapper">
        <div class="header">
            <div class="header-title">
                <i class="fa-solid fa-pills"></i> COSS
            </div>
            <div class="user-profile-icon" onclick="location.href='/profile.html'">
                <i class="fa-regular fa-user"></i>
                <div class="notification-badge" id="notiBadge"></div>
            </div>
        </div>

        <div class="content-body">
            <div class="sidebar-container" id="sidebar">
                <a href="/dashboard.html" class="sidebar-item active" data-index="0">
                    <div class="icon-box"><i class="fa-solid fa-chart-pie"></i></div>
                </a>
                <a href="/medication.html" class="sidebar-item" data-index="1">
                    <div class="icon-box"><i class="fa-solid fa-capsules"></i></div>
                </a>
                <a href="/reports.html" class="sidebar-item" data-index="2">
                    <div class="icon-box"><i class="fa-solid fa-clipboard-list"></i></div>
                </a>
                <a href="/reminder.html" class="sidebar-item" data-index="3">
                    <div class="icon-box"><i class="fa-regular fa-bell"></i></div>
                </a>
                <div class="sidebar-filler"></div>
            </div>

            <div class="main-content">
                
                <div class="welcome-text">
                    <h2>Hello, <span id="userName">User</span></h2>
                    <p>오늘의 건강 상태를 확인하세요.</p>
                </div>

                <div class="next-dose-card">
                    <div class="dose-info">
                        <h3>Next Medication</h3>
                        <div class="time" id="nextDoseTime">--:--</div>
                        <div class="med-name">
                            <i class="fa-solid fa-pills"></i> 
                            <span id="nextMedName">일정이 없습니다</span>
                        </div>
                    </div>
                    <div class="dose-action" onclick="checkMedication()">
                        <i class="fa-solid fa-check"></i>
                    </div>
                </div>

                <div class="summary-grid">
                    <div class="stat-card">
                        <div class="stat-icon green"><i class="fa-solid fa-check"></i></div>
                        <div>
                            <div class="stat-value" id="todayCount">0</div>
                            <div class="stat-label">오늘 복용</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon orange"><i class="fa-solid fa-fire"></i></div>
                        <div>
                            <div class="stat-value" id="adherenceRate">0%</div>
                            <div class="stat-label">순응도</div>
                        </div>
                    </div>
                </div>

                <div class="chart-section">
                    <div class="section-header">
                        <div class="section-title">Weekly Activity</div>
                        <i class="fa-solid fa-ellipsis" style="color: #ccc;"></i>
                    </div>
                    <canvas id="weeklyChart" height="150"></canvas>
                </div>

            </div>
        </div>
    </div>

    <script>
        // --- 1. 사이드바 곡선 효과 로직 (Design 2 핵심) ---
        const sidebarItems = document.querySelectorAll('.sidebar-item');
        const sidebarFiller = document.querySelector('.sidebar-filler');

        function updateSidebarCurves() {
            // 모든 곡선 클래스 초기화
            sidebarItems.forEach(item => {
                item.classList.remove('prev-active', 'next-active');
            });
            sidebarFiller.classList.remove('next-active');

            // 현재 active 아이템 찾기
            let activeIndex = -1;
            sidebarItems.forEach((item, index) => {
                if (item.classList.contains('active')) {
                    activeIndex = index;
                }
            });

            // 곡선 클래스 적용
            if (activeIndex !== -1) {
                // 바로 위 아이템
                if (activeIndex > 0) {
                    sidebarItems[activeIndex - 1].classList.add('prev-active');
                }
                
                // 바로 아래 아이템 (혹은 filler)
                if (activeIndex < sidebarItems.length - 1) {
                    sidebarItems[activeIndex + 1].classList.add('next-active');
                } else {
                    // 마지막 아이템이 활성 상태면 filler가 둥글게 처리
                    sidebarFiller.classList.add('next-active');
                }
            }
        }

        // 초기 실행
        updateSidebarCurves();

        // --- 2. 데이터 연동 (기존 로직 이식) ---
        const SERVER_URL = 'https://port-0-coss-mi0kk25df8c7e306.sel3.cloudtype.app';
        let authToken = null;
        let userInfo = null;

        window.addEventListener('load', () => {
            // 로컬 스토리지에서 토큰 확인
            authToken = localStorage.getItem('authToken');
            const userInfoStr = localStorage.getItem('userInfo');

            if (authToken && userInfoStr) {
                userInfo = JSON.parse(userInfoStr);
                document.getElementById('userName').textContent = userInfo.name;
                
                // 데이터 로드
                loadDashboardStats();
            } else {
                // 로그인 안된 경우 (데모 모드 or 리다이렉트)
                // window.location.href = '/index.html'; // 실제 구동 시 주석 해제
                
                // 데모 데이터 표시
                document.getElementById('userName').textContent = "Guest";
                document.getElementById('nextDoseTime').textContent = "13:00";
                document.getElementById('nextMedName').textContent = "비타민 C";
                document.getElementById('todayCount').textContent = "2";
                document.getElementById('adherenceRate').textContent = "85%";
                initChart([65, 59, 80, 81, 56, 55, 40]);
            }
        });

        async function loadDashboardStats() {
            try {
                // 실제 API 호출 (예시)
                /* const response = await fetch(`${SERVER_URL}/api/medication-stats`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await response.json(); 
                */
                
                // 더미 데이터 업데이트 (API 연동 시 교체)
                document.getElementById('nextDoseTime').textContent = "18:30";
                document.getElementById('nextMedName').textContent = "마그네슘";
                document.getElementById('todayCount').textContent = "2/3";
                document.getElementById('adherenceRate').textContent = "92%";
                
                initChart([80, 85, 90, 85, 92, 95, 92]);

            } catch (error) {
                console.error("Data load failed", error);
            }
        }

        function initChart(dataPoints) {
            const ctx = document.getElementById('weeklyChart').getContext('2d');
            
            // 그라데이션 생성
            let gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(107, 142, 107, 0.2)'); // --app-bg color
            gradient.addColorStop(1, 'rgba(107, 142, 107, 0)');

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Adherence',
                        data: dataPoints,
                        borderColor: '#6B8E6B', // 테마 색상
                        backgroundColor: gradient,
                        borderWidth: 3,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#6B8E6B',
                        pointRadius: 4,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { borderDash: [5, 5], color: '#f0f0f0' },
                            ticks: { display: false }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#999', font: { family: 'Poppins' } }
                        }
                    }
                }
            });
        }

        function checkMedication() {
            // 복약 완료 버튼 동작
            const btn = document.querySelector('.dose-action');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            setTimeout(() => {
                alert("복약이 완료되었습니다!");
                btn.innerHTML = '<i class="fa-solid fa-check"></i>';
                btn.style.backgroundColor = "#E8F5E9";
                btn.style.color = "#2E7D32";
            }, 1000);
        }

        // 사이드바 메뉴 클릭 시 active 상태 변경 (SPA 느낌)
        /* 페이지 이동 방식이므로 실제로는 각 페이지 HTML마다 해당 sidebar-item에 active 클래스를 미리 지정해야 함.
           여기서는 클릭 시 UI 반응만 테스트 */
        sidebarItems.forEach((item, index) => {
            item.addEventListener('click', function(e) {
                // e.preventDefault(); // 페이지 이동 방지 테스트용
                sidebarItems.forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                updateSidebarCurves();
            });
        });

    </script>
</body>
</html>
