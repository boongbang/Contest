<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COSS - ì•Œë¦¼ ì„¤ì •</title>
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: #f5f6fa; min-height: 100vh; }
        
        /* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ */
        .sidebar { position: fixed; left: 0; top: 0; bottom: 0; width: 250px; background: white; box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05); z-index: 1000; }
        .sidebar-header { padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .sidebar-logo { display: flex; align-items: center; gap: 10px; font-size: 24px; font-weight: bold; }
        .sidebar-menu { padding: 20px 0; }
        .menu-item { display: flex; align-items: center; gap: 15px; padding: 15px 20px; color: #666; text-decoration: none; transition: all 0.3s ease; }
        .menu-item:hover { background: #f5f6fa; color: #667eea; }
        .menu-item.active { background: rgba(102, 126, 234, 0.1); color: #667eea; border-left: 4px solid #667eea; }
        .menu-icon { font-size: 20px; width: 24px; text-align: center; }

        /* ë©”ì¸ ì»¨í…ì¸  */
        .main-content { margin-left: 250px; min-height: 100vh; }
        .top-header { background: white; padding: 20px 30px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); display: flex; justify-content: space-between; align-items: center; }
        .page-title { font-size: 24px; font-weight: 600; color: #333; }
        .reminder-content { padding: 30px; }

        /* ì¹´ë“œ ë° ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .settings-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); margin-bottom: 20px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #f0f0f0; }
        .card-title { font-size: 20px; font-weight: 600; color: #333; }
        
        .add-reminder-btn { padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
        
        .reminder-item { display: flex; align-items: center; justify-content: space-between; padding: 15px; background: #f8f9fa; border-radius: 10px; margin-bottom: 10px; }
        .reminder-info { display: flex; gap: 15px; align-items: center; }
        .reminder-icon { width: 40px; height: 40px; background: #e0e7ff; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .reminder-text h4 { margin-bottom: 5px; color: #333; }
        .reminder-text p { color: #666; font-size: 14px; }
        
        .reminder-actions button { padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer; margin-left: 5px; }
        .btn-delete { background: #fee2e2; color: #dc2626; }

        /* í† ê¸€ ìŠ¤ìœ„ì¹˜ */
        .toggle-switch { position: relative; width: 50px; height: 26px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .toggle-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: #667eea; }
        input:checked + .toggle-slider:before { transform: translateX(24px); }

        /* ëª¨ë‹¬ */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 500px; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
        .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-primary { background: #667eea; color: white; }
        .btn-secondary { background: #e5e7eb; color: #333; }

        @media (max-width: 768px) {
            .sidebar { display: none; } /* ëª¨ë°”ì¼ ë©”ë‰´ ìƒëµ */
            .main-content { margin-left: 0; }
        }
    </style>
</head>
<body>
    <nav class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo"><span>ğŸ’Š</span><span>COSS</span></div>
        </div>
        <div class="sidebar-menu">
            <a href="/dashboard.html" class="menu-item"><span>ğŸ“Š</span> ëŒ€ì‹œë³´ë“œ</a>
            <a href="/medication.html" class="menu-item"><span>ğŸ’Š</span> ë³µì•½ ê´€ë¦¬</a>
            <a href="/reports.html" class="menu-item"><span>ğŸ“ˆ</span> ìƒì„¸ ë¦¬í¬íŠ¸</a>
            <a href="/reminder.html" class="menu-item active"><span>â°</span> ì•Œë¦¼ ì„¤ì •</a>
            <a href="/profile.html" class="menu-item"><span>ğŸ‘¤</span> í”„ë¡œí•„</a>
            <a href="#" class="menu-item" onclick="logout()"><span>ğŸšª</span> ë¡œê·¸ì•„ì›ƒ</a>
        </div>
    </nav>

    <div class="main-content">
        <header class="top-header">
            <h1 class="page-title">ì•Œë¦¼ ì„¤ì •</h1>
            <span id="userName">ì‚¬ìš©ìë‹˜</span>
        </header>

        <div class="reminder-content">
            <div class="settings-card">
                <div class="card-header">
                    <h3 class="card-title">ê¸°ë³¸ ì„¤ì •</h3>
                </div>
                <div class="reminder-item">
                    <div class="reminder-info">
                        <div class="reminder-text">
                            <h4>ì „ì²´ ì•Œë¦¼ ì¼œê¸°</h4>
                            <p>ëª¨ë“  ë³µì•½ ì•Œë¦¼ì„ í™œì„±í™”í•©ë‹ˆë‹¤.</p>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="masterToggle" onchange="saveGlobalSettings()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="reminder-item">
                    <div class="reminder-info">
                        <div class="reminder-text">
                            <h4>ë°©í•´ ê¸ˆì§€ ëª¨ë“œ</h4>
                            <p>22:00 ~ 07:00 ì‚¬ì´ ì•Œë¦¼ ë„ê¸°</p>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="dndToggle" onchange="saveGlobalSettings()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <div class="settings-card">
                <div class="card-header">
                    <h3 class="card-title">ì•½ë¬¼ë³„ ì•Œë¦¼ ëª©ë¡</h3>
                    <button class="add-reminder-btn" onclick="openModal()">+ ì•Œë¦¼ ì¶”ê°€</button>
                </div>
                <div id="reminderList">
                    <p style="text-align:center; color:#999; padding:20px;">ë¡œë”© ì¤‘...</p>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="addModal">
        <div class="modal-content">
            <h3>ìƒˆ ì•Œë¦¼ ì¶”ê°€</h3>
            <div class="form-group">
                <label class="form-label">ì•½ë¬¼ ì„ íƒ</label>
                <select id="medSelect" class="form-control">
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">ì•Œë¦¼ ì‹œê°„</label>
                <input type="time" id="remindTime" class="form-control">
            </div>
            <div class="form-group">
                <label class="form-label">ë©”ì‹œì§€</label>
                <input type="text" id="remindMsg" class="form-control" placeholder="ì˜ˆ: ì‹í›„ 30ë¶„">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="saveReminder()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <script>
        const SERVER_URL = ''; // ë™ì¼ ë„ë©”ì¸ ì‚¬ìš©
        const token = localStorage.getItem('authToken');

        // ì´ˆê¸°í™”
        window.addEventListener('load', () => {
            if (!token) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/';
                return;
            }
            
            // ì‚¬ìš©ì ì´ë¦„ í‘œì‹œ
            const userStr = localStorage.getItem('userInfo');
            if (userStr) {
                const user = JSON.parse(userStr);
                document.getElementById('userName').textContent = user.name + 'ë‹˜';
            }

            loadGlobalSettings();
            loadMedications(); // ëª¨ë‹¬ìš© ì•½ë¬¼ ëª©ë¡
            loadReminders();   // ì•Œë¦¼ ëª©ë¡
        });

        // 1. ê¸€ë¡œë²Œ ì„¤ì • ë¡œë“œ/ì €ì¥ (LocalStorage)
        function loadGlobalSettings() {
            const settings = JSON.parse(localStorage.getItem('reminderSettings')) || { master: true, dnd: false };
            document.getElementById('masterToggle').checked = settings.master;
            document.getElementById('dndToggle').checked = settings.dnd;
        }

        function saveGlobalSettings() {
            const settings = {
                master: document.getElementById('masterToggle').checked,
                dnd: document.getElementById('dndToggle').checked
            };
            localStorage.setItem('reminderSettings', JSON.stringify(settings));
        }

        // 2. ì•½ë¬¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (DB -> Select Box)
        async function loadMedications() {
            try {
                const res = await fetch('/api/medications', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                const select = document.getElementById('medSelect');
                select.innerHTML = '<option value="">ì„ íƒí•˜ì„¸ìš”</option>';
                
                if (data.success) {
                    data.data.forEach(med => {
                        const option = document.createElement('option');
                        option.value = med.id;
                        option.textContent = med.name;
                        select.appendChild(option);
                    });
                }
            } catch (e) {
                console.error('ì•½ë¬¼ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨', e);
            }
        }

        // 3. ì•Œë¦¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (DB)
        async function loadReminders() {
            const listDiv = document.getElementById('reminderList');
            // API ì—”ë“œí¬ì¸íŠ¸ê°€ ì—†ë‹¤ë©´ medications í…Œì´ë¸”ì˜ scheduleì„ ëŒ€ì‹  ë³´ì—¬ì£¼ëŠ” ë°©ì‹ìœ¼ë¡œ êµ¬í˜„ ê°€ëŠ¥
            // ì—¬ê¸°ì„œëŠ” /api/medications ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì•Œë¦¼ ë¦¬ìŠ¤íŠ¸ë¥¼ ì¬êµ¬ì„±í•©ë‹ˆë‹¤.
            
            try {
                const res = await fetch('/api/medications', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                
                if (!data.success || data.data.length === 0) {
                    listDiv.innerHTML = '<p style="text-align:center; padding:20px;">ë“±ë¡ëœ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                let html = '';
                data.data.forEach(med => {
                    // ê° ì•½ë¬¼ì— ì„¤ì •ëœ ìŠ¤ì¼€ì¤„ì´ ìˆë‹¤ë©´ í‘œì‹œ
                    if (med.schedule && med.schedule.length > 0) {
                        med.schedule.forEach(time => {
                            html += `
                                <div class="reminder-item">
                                    <div class="reminder-info">
                                        <div class="reminder-icon">â°</div>
                                        <div class="reminder-text">
                                            <h4>${med.name}</h4>
                                            <p>${time} ì•Œë¦¼</p>
                                        </div>
                                    </div>
                                    <div class="reminder-actions">
                                        <button class="btn-delete" onclick="alert('ë³µì•½ ê´€ë¦¬ í˜ì´ì§€ì—ì„œ ìˆ˜ì •í•´ì£¼ì„¸ìš”.')">ê´€ë¦¬</button>
                                    </div>
                                </div>
                            `;
                        });
                    }
                });
                
                if (html === '') html = '<p style="text-align:center;">ì„¤ì •ëœ ë³µì•½ ì‹œê°„ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                listDiv.innerHTML = html;

            } catch (e) {
                listDiv.innerHTML = '<p style="color:red; text-align:center;">ë¡œë“œ ì‹¤íŒ¨</p>';
            }
        }

        // 4. ëª¨ë‹¬ ê´€ë ¨
        function openModal() { document.getElementById('addModal').classList.add('active'); }
        function closeModal() { document.getElementById('addModal').classList.remove('active'); }

        // 5. ì•Œë¦¼ ì €ì¥ (ì‚¬ì‹¤ìƒ ì•½ë¬¼ ìŠ¤ì¼€ì¤„ ì¶”ê°€ ë¡œì§)
        async function saveReminder() {
            // ì´ ì˜ˆì œì—ì„œëŠ” ë‹¨ìˆœ UI êµ¬í˜„. ì‹¤ì œë¡œëŠ” ì•½ë¬¼ ìˆ˜ì • APIë¥¼ í˜¸ì¶œí•´ì•¼ í•¨.
            alert('ë³µì•½ ê´€ë¦¬ í˜ì´ì§€ì—ì„œ ì•½ë¬¼ì„ ìˆ˜ì •í•˜ì—¬ ì‹œê°„ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
            closeModal();
        }

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userInfo');
            window.location.href = '/';
        }
    </script>
</body>
</html>
