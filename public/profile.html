<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COSS - 프로필</title>
    <link rel="stylesheet" href="styles.css"> <style>
        /* 기존 스타일 유지 + 알림창 스타일 */
        body { font-family: sans-serif; background: #f5f6fa; margin: 0; }
        .main-content { padding: 20px; max-width: 800px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #5a6fd8; }
        .alert { padding: 10px; margin-bottom: 10px; border-radius: 5px; display: none; }
        .alert.success { background: #d4edda; color: #155724; }
        .alert.error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="main-content">
        <h1>프로필 설정</h1>
        <div id="alertBox" class="alert"></div>

        <div class="card">
            <h3>기본 정보</h3>
            <form id="profileForm">
                <div class="form-group">
                    <label>이름</label>
                    <input type="text" id="name" required>
                </div>
                <div class="form-group">
                    <label>이메일</label>
                    <input type="email" id="email" disabled style="background: #eee;">
                </div>
                <div class="form-group">
                    <label>전화번호</label>
                    <input type="tel" id="phone">
                </div>
                <div class="form-group">
                    <label>생년월일</label>
                    <input type="date" id="birthdate">
                </div>
                <div class="form-group">
                    <label>성별</label>
                    <select id="gender">
                        <option value="male">남성</option>
                        <option value="female">여성</option>
                    </select>
                </div>
                <button type="submit">저장하기</button>
            </form>
        </div>

        <div class="card">
            <h3>비밀번호 변경</h3>
            <form id="passwordForm">
                <div class="form-group">
                    <label>현재 비밀번호</label>
                    <input type="password" id="currentPassword" required>
                </div>
                <div class="form-group">
                    <label>새 비밀번호</label>
                    <input type="password" id="newPassword" required>
                </div>
                <button type="submit">변경하기</button>
            </form>
        </div>
        
        <button onclick="location.href='/dashboard.html'" style="background: #666;">대시보드로 돌아가기</button>
    </div>

    <script>
        const SERVER_URL = ''; // 상대 경로 사용
        const token = localStorage.getItem('authToken');

        // 초기 로드
        window.addEventListener('load', async () => {
            if (!token) {
                alert('로그인이 필요합니다.');
                window.location.href = '/';
                return;
            }
            await loadProfile();
        });

        async function loadProfile() {
            try {
                const res = await fetch('/api/auth/profile', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (data.success) {
                    const user = data.data;
                    document.getElementById('name').value = user.name || '';
                    document.getElementById('email').value = user.email || '';
                    document.getElementById('phone').value = user.phone || '';
                    if(user.birthdate) document.getElementById('birthdate').value = user.birthdate.split('T')[0];
                    document.getElementById('gender').value = user.gender || 'male';
                }
            } catch (e) {
                console.error(e);
            }
        }

        // 프로필 저장
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const body = {
                name: document.getElementById('name').value,
                phone: document.getElementById('phone').value,
                birthdate: document.getElementById('birthdate').value,
                gender: document.getElementById('gender').value
            };

            try {
                const res = await fetch('/api/auth/profile', {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify(body)
                });
                const result = await res.json();
                showAlert(result.success ? '저장되었습니다.' : '실패: ' + result.error, result.success);
            } catch (e) {
                showAlert('통신 오류 발생', false);
            }
        });

        // 비밀번호 변경
        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;

            try {
                const res = await fetch('/api/auth/change-password', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify({ currentPassword, newPassword })
                });
                const result = await res.json();
                showAlert(result.message || result.error, result.success);
                if (result.success) document.getElementById('passwordForm').reset();
            } catch (e) {
                showAlert('통신 오류 발생', false);
            }
        });

        function showAlert(msg, isSuccess) {
            const box = document.getElementById('alertBox');
            box.textContent = msg;
            box.className = `alert ${isSuccess ? 'success' : 'error'}`;
            box.style.display = 'block';
            setTimeout(() => box.style.display = 'none', 3000);
        }
    </script>
</body>
</html>
