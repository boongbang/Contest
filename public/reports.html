<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COSS - ìƒì„¸ ë¦¬í¬íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: #f5f6fa; min-height: 100vh; }
        
        .sidebar { position: fixed; left: 0; top: 0; bottom: 0; width: 250px; background: white; box-shadow: 2px 0 10px rgba(0, 0, 0, 0.05); }
        .sidebar-header { padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .sidebar-logo { display: flex; align-items: center; gap: 10px; font-size: 24px; font-weight: bold; }
        .sidebar-menu { padding: 20px 0; }
        .menu-item { display: flex; align-items: center; gap: 15px; padding: 15px 20px; color: #666; text-decoration: none; transition: all 0.3s ease; }
        .menu-item:hover { background: #f5f6fa; color: #667eea; }
        .menu-item.active { background: rgba(102, 126, 234, 0.1); color: #667eea; border-left: 4px solid #667eea; }

        .main-content { margin-left: 250px; min-height: 100vh; }
        .top-header { background: white; padding: 20px 30px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); display: flex; justify-content: space-between; align-items: center; }
        .page-title { font-size: 24px; font-weight: 600; color: #333; }
        .reports-content { padding: 30px; }

        /* í•„í„° ì„¹ì…˜ */
        .filter-section { background: white; padding: 20px; border-radius: 15px; display: flex; gap: 15px; margin-bottom: 20px; align-items: flex-end; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-label { font-size: 14px; color: #666; }
        .filter-input { padding: 8px; border: 1px solid #ddd; border-radius: 6px; }
        .btn-filter { padding: 8px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; height: 35px; }

        /* ë¦¬í¬íŠ¸ ê·¸ë¦¬ë“œ */
        .report-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .report-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .card-title { font-size: 18px; font-weight: 600; margin-bottom: 15px; color: #333; }
        
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .stat-label { color: #666; }
        .stat-value { font-weight: bold; color: #333; font-size: 18px; }
        .stat-change { font-size: 12px; padding: 2px 6px; border-radius: 4px; }
        .positive { background: #d1fae5; color: #065f46; }
        .negative { background: #fee2e2; color: #991b1b; }

        /* ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ */
        .chart-container { position: relative; height: 300px; width: 100%; }

        @media (max-width: 768px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; }
            .filter-section { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>
    <nav class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo"><span>ğŸ’Š</span><span>COSS</span></div>
        </div>
        <div class="sidebar-menu">
            <a href="/dashboard.html" class="menu-item"><span>ğŸ“Š</span> ëŒ€ì‹œë³´ë“œ</a>
            <a href="/medication.html" class="menu-item"><span>ğŸ’Š</span> ë³µì•½ ê´€ë¦¬</a>
            <a href="/reports.html" class="menu-item active"><span>ğŸ“ˆ</span> ìƒì„¸ ë¦¬í¬íŠ¸</a>
            <a href="/reminder.html" class="menu-item"><span>â°</span> ì•Œë¦¼ ì„¤ì •</a>
            <a href="/profile.html" class="menu-item"><span>ğŸ‘¤</span> í”„ë¡œí•„</a>
            <a href="#" class="menu-item" onclick="logout()"><span>ğŸšª</span> ë¡œê·¸ì•„ì›ƒ</a>
        </div>
    </nav>

    <div class="main-content">
        <header class="top-header">
            <h1 class="page-title">ìƒì„¸ ë¦¬í¬íŠ¸</h1>
            <span id="userName">ì‚¬ìš©ìë‹˜</span>
        </header>

        <div class="reports-content">
            <div class="filter-section">
                <div class="filter-group">
                    <label class="filter-label">ì‹œì‘ì¼</label>
                    <input type="date" id="startDate" class="filter-input">
                </div>
                <div class="filter-group">
                    <label class="filter-label">ì¢…ë£Œì¼</label>
                    <input type="date" id="endDate" class="filter-input">
                </div>
                <button class="btn-filter" onclick="loadReportData()">ì¡°íšŒ</button>
            </div>

            <div class="report-grid">
                <div class="report-card">
                    <h3 class="card-title">ë³µì•½ ìˆœì‘ë„ ì§€í‘œ</h3>
                    <div class="stat-row">
                        <span class="stat-label">PDC (ë³µì•½ì¼ ë¹„ìœ¨)</span>
                        <div>
                            <span class="stat-value" id="pdcValue">0%</span>
                            <span class="stat-change positive">Good</span>
                        </div>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">MPR (ì•½ë¬¼ ì†Œì§€ìœ¨)</span>
                        <div>
                            <span class="stat-value" id="mprValue">0%</span>
                        </div>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">ì‹œê°„ ì¼ê´€ì„±</span>
                        <div>
                            <span class="stat-value" id="consistencyValue">0%</span>
                        </div>
                    </div>
                </div>

                <div class="report-card">
                    <h3 class="card-title">AI ë¶„ì„ ë° ê¶Œì¥</h3>
                    <div style="margin-bottom: 15px;">
                        <strong>ì˜ˆìƒ ìˆœì‘ë„:</strong>
                        <span id="nextWeekPred" style="color: #667eea; font-weight:bold;">ë¶„ì„ ì¤‘...</span>
                    </div>
                    <div id="recommendations" style="font-size: 14px; color: #555; line-height: 1.6;">
                        ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
                    </div>
                </div>
            </div>

            <div class="report-card">
                <h3 class="card-title">ì£¼ê°„ ë³µì•½ ì¶”ì„¸</h3>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SERVER_URL = '';
        const token = localStorage.getItem('authToken');
        let trendChart = null;

        window.addEventListener('load', () => {
            if (!token) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                window.location.href = '/';
                return;
            }
            
            // ë‚ ì§œ ê¸°ë³¸ê°’ (ìµœê·¼ 30ì¼)
            const end = new Date();
            const start = new Date();
            start.setDate(end.getDate() - 30);
            
            document.getElementById('endDate').value = end.toISOString().split('T')[0];
            document.getElementById('startDate').value = start.toISOString().split('T')[0];

            loadReportData();
        });

        async function loadReportData() {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;

            try {
                // 1. ë¦¬í¬íŠ¸ í†µê³„ API í˜¸ì¶œ
                const res = await fetch(`/api/reports?start_date=${start}&end_date=${end}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                if (data.success) {
                    // ìˆ˜ì¹˜ ì—…ë°ì´íŠ¸
                    document.getElementById('pdcValue').textContent = `${data.pdc}%`;
                    document.getElementById('mprValue').textContent = `${data.mpr}%`;
                    document.getElementById('consistencyValue').textContent = `${data.consistency}%`;
                    
                    // ì˜ˆì¸¡ ë°ì´í„°ê°€ ìˆë‹¤ë©´ í‘œì‹œ (server.js ë¡œì§ì— ë”°ë¼ ë‹¤ë¦„)
                    if (data.predictions) {
                        document.getElementById('nextWeekPred').textContent = `${data.predictions.next_week_adherence || 0}%`;
                        const recs = data.predictions.recommendations || [];
                        const recHtml = recs.length > 0 
                            ? '<ul>' + recs.map(r => `<li>${r}</li>`).join('') + '</ul>' 
                            : 'íŠ¹ì´ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.';
                        document.getElementById('recommendations').innerHTML = recHtml;
                    }
                }

                // 2. ì°¨íŠ¸ ë°ì´í„° ë¡œë“œ (ë¡œê·¸ ê¸°ë°˜)
                loadChartData(start, end);

            } catch (e) {
                console.error('ë¦¬í¬íŠ¸ ë¡œë“œ ì‹¤íŒ¨', e);
            }
        }

        async function loadChartData(start, end) {
            try {
                const res = await fetch(`/api/medication-logs?start_date=${start}&end_date=${end}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const result = await res.json();

                if (result.success) {
                    // ë‚ ì§œë³„ ë³µì•½ íšŸìˆ˜ ì§‘ê³„
                    const logs = result.data;
                    const dailyCounts = {};
                    
                    logs.forEach(log => {
                        const date = log.timestamp.split('T')[0];
                        dailyCounts[date] = (dailyCounts[date] || 0) + 1;
                    });

                    // ì°¨íŠ¸ ë°ì´í„° í¬ë§·íŒ…
                    const labels = Object.keys(dailyCounts).sort();
                    const values = labels.map(date => dailyCounts[date]);

                    renderChart(labels, values);
                }
            } catch (e) {
                console.error('ì°¨íŠ¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨', e);
            }
        }

        function renderChart(labels, data) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            if (trendChart) {
                trendChart.destroy();
            }

            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì¼ì¼ ë³µì•½ íšŸìˆ˜',
                        data: data,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { stepSize: 1 } }
                    }
                }
            });
        }

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('userInfo');
            window.location.href = '/';
        }
    </script>
</body>
</html>
