<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>COSS Reports - ìƒì„¸ í†µê³„ ë° ë¶„ì„</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- 1. ê¸°ë³¸ ì„¤ì • ë° ë¦¬ì…‹ --- */
        :root {
            --app-bg-white: #ffffff;
            --app-green: #6B8E6B;
            --app-dark-green: #556b57;
            --app-light-green: #7A987D;
            --app-lighter-green: #8fae92;
            --app-text-cream: #F1F5EF;
            --app-radius: 70px;
            --success-green: #4CAF50;
            --warning-orange: #FF9800;
            --error-red: #F44336;
            --border-color: #e0e0e0;
            
            /* ì„¼ì„œë³„ ìƒ‰ìƒ */
            --sensor-1-color: #FF6B6B;
            --sensor-2-color: #4ECDC4;
            --sensor-3-color: #45B7D1;
            --sensor-4-color: #96CEB4;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px 0;
        }

        /* --- 2. ë°˜ì‘í˜• ì»¨í…Œì´ë„ˆ --- */
        .app-wrapper {
            width: 100%;
            max-width: 100%;
            background-color: var(--app-bg-white);
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-height: 100vh;
        }

        @media (min-width: 481px) {
            .app-wrapper {
                width: 414px;
                min-height: auto;
                border-radius: 40px;
                box-shadow: 0 30px 60px rgba(0,0,0,0.15);
                margin: 20px auto;
            }
        }

        /* --- 3. ìƒë‹¨ ë…¹ìƒ‰ ì˜ì—­ --- */
        .top-section {
            background-color: var(--app-green);
            position: relative;
            padding: 20px 25px 60px 25px;
            color: var(--app-text-cream);
            border-bottom-right-radius: var(--app-radius);
            z-index: 10;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            height: 50px;
        }

        .logo {
            font-weight: 600;
            font-size: 1.1rem;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .header-icons {
            display: flex;
            gap: 12px;
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            cursor: pointer;
            transition: all 0.3s;
            color: white;
            text-decoration: none;
            border: none;
        }

        .icon-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        /* í—¤ë” íƒ€ì´í‹€ */
        .header-title {
            text-align: center;
            margin-top: 20px;
        }

        .header-title h1 {
            font-family: 'Merriweather', serif;
            font-size: 1.8rem;
            margin-bottom: 5px;
        }

        .header-subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* --- 4. ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ --- */
        .main-content {
            flex: 1;
            padding: 30px 25px;
            background: var(--app-bg-white);
        }

        /* --- 5. í•µì‹¬ ì§€í‘œ ì¹´ë“œ --- */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .metric-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--app-green);
        }

        .metric-card.sensor-1::before { background: var(--sensor-1-color); }
        .metric-card.sensor-2::before { background: var(--sensor-2-color); }
        .metric-card.sensor-3::before { background: var(--sensor-3-color); }
        .metric-card.sensor-4::before { background: var(--sensor-4-color); }

        .metric-emoji {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .metric-label {
            font-size: 0.85rem;
            color: #999;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--app-green);
        }

        .metric-change {
            font-size: 0.8rem;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .metric-change.positive {
            color: var(--success-green);
        }

        .metric-change.negative {
            color: var(--error-red);
        }

        /* --- 6. ë ˆì´ë” ì°¨íŠ¸ ì„¹ì…˜ --- */
        .chart-section {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--app-green);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-container {
            height: 300px;
            position: relative;
        }

        /* --- 7. ì„¼ì„œë³„ ìƒì„¸ ë¶„ì„ íƒ­ --- */
        .sensor-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 5px;
            border-radius: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
        }

        .sensor-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            color: #666;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .sensor-tab.active {
            background: linear-gradient(135deg, var(--app-green) 0%, var(--app-light-green) 100%);
            color: white;
            transform: scale(1.05);
        }

        .sensor-tab-emoji {
            font-size: 1.5rem;
        }

        .sensor-tab-name {
            font-size: 0.85rem;
        }

        /* --- 8. ë¶„ì„ ë‚´ìš© --- */
        .analysis-content {
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .analysis-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 15px;
            border-left: 4px solid var(--app-green);
        }

        .analysis-item.sensor-1 { border-left-color: var(--sensor-1-color); }
        .analysis-item.sensor-2 { border-left-color: var(--sensor-2-color); }
        .analysis-item.sensor-3 { border-left-color: var(--sensor-3-color); }
        .analysis-item.sensor-4 { border-left-color: var(--sensor-4-color); }

        .analysis-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--app-green);
        }

        .analysis-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .analysis-description {
            font-size: 0.9rem;
            color: #666;
        }

        /* --- 9. ì‹œê°„ëŒ€ë³„ ë¶„í¬ ì°¨íŠ¸ --- */
        .distribution-chart {
            height: 200px;
            margin-top: 20px;
        }

        /* --- 10. ì§„ë‹¨ ì¹´ë“œ --- */
        .diagnosis-cards {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .diagnosis-card {
            padding: 20px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .diagnosis-card.excellent {
            background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
            border: 1px solid var(--success-green);
        }

        .diagnosis-card.good {
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            border: 1px solid #2196F3;
        }

        .diagnosis-card.warning {
            background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%);
            border: 1px solid var(--warning-orange);
        }

        .diagnosis-card.danger {
            background: linear-gradient(135deg, #FFEBEE 0%, #FFCDD2 100%);
            border: 1px solid var(--error-red);
        }

        .diagnosis-icon {
            font-size: 2rem;
        }

        .diagnosis-content {
            flex: 1;
        }

        .diagnosis-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .diagnosis-message {
            font-size: 0.9rem;
            color: #666;
        }

        /* --- 11. ì¸ì‚¬ì´íŠ¸ ì„¹ì…˜ --- */
        .insights-section {
            background: linear-gradient(135deg, var(--app-green) 0%, var(--app-light-green) 100%);
            padding: 25px;
            border-radius: 20px;
            color: white;
            margin-top: 20px;
        }

        .insight-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .insight-list {
            list-style: none;
        }

        .insight-item {
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .insight-item:last-child {
            border-bottom: none;
        }

        .insight-icon {
            margin-top: 2px;
        }

        /* --- 12. í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ --- */
        .bottom-nav {
            display: flex;
            justify-content: space-around;
            padding: 20px 25px;
            background: white;
            border-top: 1px solid var(--border-color);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            color: #999;
            text-decoration: none;
            transition: all 0.3s;
            cursor: pointer;
        }

        .nav-item:hover,
        .nav-item.active {
            color: var(--app-green);
        }

        .nav-icon {
            font-size: 1.5rem;
        }

        .nav-label {
            font-size: 0.75rem;
        }

        /* --- 13. ë¡œë”© ìƒíƒœ --- */
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(107, 142, 107, 0.1);
            border-top-color: var(--app-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* --- 14. ë¹ˆ ìƒíƒœ --- */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-icon {
            font-size: 4rem;
            color: #ddd;
            margin-bottom: 20px;
        }

        .empty-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #666;
            margin-bottom: 10px;
        }

        .empty-description {
            color: #999;
            margin-bottom: 20px;
        }

        .empty-action {
            background: var(--app-green);
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s;
        }

        .empty-action:hover {
            background: var(--app-dark-green);
            transform: translateY(-2px);
        }

        /* --- 15. ì• ë‹ˆë©”ì´ì…˜ --- */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .slide-up {
            animation: slideUp 0.5s ease-out;
        }

        /* ë°˜ì‘í˜• ì¡°ì • */
        @media (max-width: 480px) {
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .sensor-tabs {
                flex-wrap: wrap;
            }
            
            .sensor-tab {
                flex: 1 1 45%;
            }
        }

        /* í† ìŠ¤íŠ¸ ì•Œë¦¼ */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #333;
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.success { background: var(--success-green); }
        .toast.warning { background: var(--warning-orange); }
        .toast.error { background: var(--error-red); }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <!-- ìƒë‹¨ ë…¹ìƒ‰ ì˜ì—­ -->
        <div class="top-section">
            <div class="header">
                <a href="/dashboard.html" class="icon-btn">
                    <i class="fa-solid fa-arrow-left"></i>
                </a>
                <div class="logo">
                    <i class="fa-solid fa-chart-line"></i>
                    <span>COSS Reports</span>
                </div>
                <div class="header-icons">
                    <button class="icon-btn" onclick="exportReport()">
                        <i class="fa-solid fa-download"></i>
                    </button>
                </div>
            </div>
            
            <div class="header-title">
                <h1>ë³µì•½ ë¶„ì„ ë¦¬í¬íŠ¸</h1>
                <p class="header-subtitle" id="reportDate">2024ë…„ 12ì›” ë¶„ì„</p>
            </div>
        </div>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <div class="main-content">
            <!-- 4ê°œ ì„¼ì„œ í•µì‹¬ ì§€í‘œ -->
            <div class="metrics-grid" id="metricsGrid">
                <div class="metric-card sensor-1" onclick="switchSensor(1)">
                    <div class="metric-emoji">ğŸŒ…</div>
                    <div class="metric-label">ì•„ì¹¨ ì•½ (Sensor 1)</div>
                    <div class="metric-value"><span id="sensor1Rate">0</span>%</div>
                    <div class="metric-change positive" id="sensor1Change">
                        <i class="fa-solid fa-arrow-up"></i>
                        <span>+0%</span>
                    </div>
                </div>
                <div class="metric-card sensor-2" onclick="switchSensor(2)">
                    <div class="metric-emoji">â˜€ï¸</div>
                    <div class="metric-label">ì ì‹¬ ì•½ (Sensor 2)</div>
                    <div class="metric-value"><span id="sensor2Rate">0</span>%</div>
                    <div class="metric-change positive" id="sensor2Change">
                        <i class="fa-solid fa-arrow-up"></i>
                        <span>+0%</span>
                    </div>
                </div>
                <div class="metric-card sensor-3" onclick="switchSensor(3)">
                    <div class="metric-emoji">ğŸŒ™</div>
                    <div class="metric-label">ì €ë… ì•½ (Sensor 3)</div>
                    <div class="metric-value"><span id="sensor3Rate">0</span>%</div>
                    <div class="metric-change positive" id="sensor3Change">
                        <i class="fa-solid fa-arrow-up"></i>
                        <span>+0%</span>
                    </div>
                </div>
                <div class="metric-card sensor-4" onclick="switchSensor(4)">
                    <div class="metric-emoji">ğŸ›Œ</div>
                    <div class="metric-label">ìê¸°ì „ ì•½ (Sensor 4)</div>
                    <div class="metric-value"><span id="sensor4Rate">0</span>%</div>
                    <div class="metric-change positive" id="sensor4Change">
                        <i class="fa-solid fa-arrow-up"></i>
                        <span>+0%</span>
                    </div>
                </div>
            </div>

            <!-- ë ˆì´ë” ì°¨íŠ¸ (4ê°œ ì¶•) -->
            <div class="chart-section fade-in">
                <h3 class="section-title">
                    <i class="fa-solid fa-spider"></i>
                    ë³µì•½ íŒ¨í„´ ë¶„ì„ (Radar Chart)
                </h3>
                <div class="chart-container">
                    <canvas id="radarChart"></canvas>
                </div>
            </div>

            <!-- ì„¼ì„œë³„ ìƒì„¸ ë¶„ì„ íƒ­ -->
            <div class="sensor-tabs">
                <div class="sensor-tab active" onclick="switchSensor(1)">
                    <span class="sensor-tab-emoji">ğŸŒ…</span>
                    <span class="sensor-tab-name">ì•„ì¹¨</span>
                </div>
                <div class="sensor-tab" onclick="switchSensor(2)">
                    <span class="sensor-tab-emoji">â˜€ï¸</span>
                    <span class="sensor-tab-name">ì ì‹¬</span>
                </div>
                <div class="sensor-tab" onclick="switchSensor(3)">
                    <span class="sensor-tab-emoji">ğŸŒ™</span>
                    <span class="sensor-tab-name">ì €ë…</span>
                </div>
                <div class="sensor-tab" onclick="switchSensor(4)">
                    <span class="sensor-tab-emoji">ğŸ›Œ</span>
                    <span class="sensor-tab-name">ìê¸°ì „</span>
                </div>
            </div>

            <!-- ì„ íƒëœ ì„¼ì„œ ìƒì„¸ ë¶„ì„ -->
            <div class="analysis-content slide-up" id="sensorAnalysis">
                <h3 class="section-title">
                    <span id="selectedSensorEmoji">ğŸŒ…</span>
                    <span id="selectedSensorName">ì•„ì¹¨ ì•½</span> ìƒì„¸ ë¶„ì„
                </h3>
                
                <div class="analysis-grid">
                    <div class="analysis-item" id="analysisItem">
                        <div class="analysis-title">ë³µìš© ì„±ê³µë¥ </div>
                        <div class="analysis-value" id="analysisSuccessRate">0%</div>
                        <div class="analysis-description">ì§€ë‚œ 30ì¼ ê¸°ì¤€</div>
                    </div>
                    
                    <div class="analysis-item">
                        <div class="analysis-title">ì´ ë³µìš© íšŸìˆ˜</div>
                        <div class="analysis-value" id="analysisTotalCount">0íšŒ</div>
                        <div class="analysis-description">ëª©í‘œ ì‹œê°„: <span id="analysisTargetTime">08:00</span></div>
                    </div>
                    
                    <div class="analysis-item">
                        <div class="analysis-title">ì—°ì† ë³µìš© ì¼ìˆ˜</div>
                        <div class="analysis-value" id="analysisStreak">0ì¼</div>
                        <div class="analysis-description">ìµœê³  ê¸°ë¡: <span id="analysisMaxStreak">0ì¼</span></div>
                    </div>
                </div>

                <!-- ì‹œê°„ëŒ€ë³„ ë¶„í¬ ì°¨íŠ¸ -->
                <div class="distribution-chart">
                    <canvas id="distributionChart"></canvas>
                </div>
            </div>

            <!-- ì§„ë‹¨ ì¹´ë“œ -->
            <div class="diagnosis-cards">
                <div class="diagnosis-card excellent" id="diagnosisCard1">
                    <div class="diagnosis-icon">ğŸ†</div>
                    <div class="diagnosis-content">
                        <div class="diagnosis-title">ë°ì´í„° ìˆ˜ì§‘ ì¤‘</div>
                        <div class="diagnosis-message">ë³µì•½ ë°ì´í„°ê°€ ìŒ“ì´ë©´ ë§ì¶¤í˜• ë¶„ì„ì„ ì œê³µí•©ë‹ˆë‹¤.</div>
                    </div>
                </div>
                
                <div class="diagnosis-card warning" id="diagnosisCard2">
                    <div class="diagnosis-icon">âš ï¸</div>
                    <div class="diagnosis-content">
                        <div class="diagnosis-title">ì£¼ì˜ í•„ìš”</div>
                        <div class="diagnosis-message">ë¶„ì„ ëŒ€ê¸° ì¤‘...</div>
                    </div>
                </div>
                
                <div class="diagnosis-card good" id="diagnosisCard3">
                    <div class="diagnosis-icon">ğŸ“ˆ</div>
                    <div class="diagnosis-content">
                        <div class="diagnosis-title">ì „ì²´ ìˆœì‘ë„</div>
                        <div class="diagnosis-message">ë°ì´í„° ë¶„ì„ ëŒ€ê¸° ì¤‘...</div>
                    </div>
                </div>
            </div>

            <!-- AI ì¸ì‚¬ì´íŠ¸ -->
            <div class="insights-section">
                <h3 class="insight-title">
                    <i class="fa-solid fa-lightbulb"></i>
                    AI ì¸ì‚¬ì´íŠ¸
                </h3>
                <ul class="insight-list" id="insightsList">
                    <li class="insight-item">
                        <span class="insight-icon">ğŸ“Š</span>
                        <span>ë³µì•½ ë°ì´í„°ê°€ ìŒ“ì´ë©´ ê°œì¸í™”ëœ ì¸ì‚¬ì´íŠ¸ë¥¼ ì œê³µí•©ë‹ˆë‹¤.</span>
                    </li>
                    <li class="insight-item">
                        <span class="insight-icon">â°</span>
                        <span>ê° ì‹œê°„ëŒ€ë³„ ë³µì•½ íŒ¨í„´ì„ ë¶„ì„í•˜ì—¬ ìµœì ì˜ ì•Œë¦¼ ì‹œê°„ì„ ì œì•ˆí•©ë‹ˆë‹¤.</span>
                    </li>
                    <li class="insight-item">
                        <span class="insight-icon">âœ¨</span>
                        <span>ê¾¸ì¤€íˆ ì•½ì„ ë³µìš©í•˜ë©´ ê±´ê°• ê°œì„  íš¨ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!</span>
                    </li>
                </ul>
            </div>
        </div>

        <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="bottom-nav">
            <a href="/dashboard.html" class="nav-item">
                <i class="fa-solid fa-house nav-icon"></i>
                <span class="nav-label">í™ˆ</span>
            </a>
            <div class="nav-item active">
                <i class="fa-solid fa-chart-line nav-icon"></i>
                <span class="nav-label">ë¦¬í¬íŠ¸</span>
            </div>
            <div class="nav-item" onclick="refreshReport()">
                <i class="fa-solid fa-sync-alt nav-icon"></i>
                <span class="nav-label">ìƒˆë¡œê³ ì¹¨</span>
            </div>
            <a href="/dashboard.html" class="nav-item">
                <i class="fa-solid fa-gear nav-icon"></i>
                <span class="nav-label">ì„¤ì •</span>
            </a>
        </div>
    </div>

    <!-- í† ìŠ¤íŠ¸ ì•Œë¦¼ -->
    <div class="toast" id="toast">
        <span id="toastMessage"></span>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        const API_URL = window.location.origin;
        let authToken = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
        let reportData = null;
        let charts = {};
        let currentSensor = 1;

        // ì„¼ì„œ ì •ë³´ ë§µí•‘
        const sensorInfo = {
            1: { emoji: 'ğŸŒ…', name: 'ì•„ì¹¨ ì•½', time: '08:00', color: '#FF6B6B' },
            2: { emoji: 'â˜€ï¸', name: 'ì ì‹¬ ì•½', time: '13:00', color: '#4ECDC4' },
            3: { emoji: 'ğŸŒ™', name: 'ì €ë… ì•½', time: '18:00', color: '#45B7D1' },
            4: { emoji: 'ğŸ›Œ', name: 'ìê¸°ì „ ì•½', time: '22:00', color: '#96CEB4' }
        };

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', () => {
            if (!authToken) {
                window.location.href = '/index.html';
                return;
            }

            // í˜„ì¬ ë‚ ì§œ í‘œì‹œ
            const now = new Date();
            document.getElementById('reportDate').textContent = 
                `${now.getFullYear()}ë…„ ${now.getMonth() + 1}ì›” ë¶„ì„`;

            // ë¦¬í¬íŠ¸ ë°ì´í„° ë¡œë“œ
            loadReportData();
        });

        // ë¦¬í¬íŠ¸ ë°ì´í„° ë¡œë“œ
        async function loadReportData() {
            try {
                const response = await fetch(`${API_URL}/api/reports/detailed`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load report data');

                reportData = await response.json();
                console.log('Report Data:', reportData);
                
                // UI ì—…ë°ì´íŠ¸
                updateMetrics();
                updateRadarChart();
                updateSensorAnalysis(currentSensor);
                updateDiagnosisCards();
                updateInsights();

                showToast('ë¦¬í¬íŠ¸ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');

            } catch (error) {
                console.error('Failed to load report:', error);
                showToast('ë¦¬í¬íŠ¸ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                // ë¹ˆ ìƒíƒœ ëŒ€ì‹  ê¸°ë³¸ê°’ ìœ ì§€
            }
        }

        // í•µì‹¬ ì§€í‘œ ì—…ë°ì´íŠ¸
        function updateMetrics() {
            if (!reportData || !reportData.sensorStats) return;

            for (let i = 1; i <= 4; i++) {
                const stat = reportData.sensorStats[i];
                if (stat) {
                    document.getElementById(`sensor${i}Rate`).textContent = stat.successRate || 0;
                    
                    // ë³€í™”ìœ¨ ê³„ì‚° (ì‹¤ì œ ë°ì´í„° ê¸°ë°˜ ë˜ëŠ” ì‹œë®¬ë ˆì´ì…˜)
                    const changeEl = document.getElementById(`sensor${i}Change`);
                    const changeValue = calculateChangeRate(i);
                    
                    if (changeValue >= 0) {
                        changeEl.className = 'metric-change positive';
                        changeEl.innerHTML = `<i class="fa-solid fa-arrow-up"></i><span>+${changeValue}%</span>`;
                    } else {
                        changeEl.className = 'metric-change negative';
                        changeEl.innerHTML = `<i class="fa-solid fa-arrow-down"></i><span>${changeValue}%</span>`;
                    }
                }
            }
        }

        // ë³€í™”ìœ¨ ê³„ì‚° (ê°„ë‹¨í•œ ì‹œë®¬ë ˆì´ì…˜)
        function calculateChangeRate(sensorId) {
            if (!reportData || !reportData.sensorStats[sensorId]) return 0;
            // ì‹¤ì œë¡œëŠ” ì´ì „ ê¸°ê°„ê³¼ ë¹„êµí•´ì•¼ í•¨
            const rate = reportData.sensorStats[sensorId].successRate || 0;
            return Math.floor((rate / 10) - 5 + Math.random() * 10);
        }

        // ë ˆì´ë” ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        function updateRadarChart() {
            const ctx = document.getElementById('radarChart');
            if (!ctx) return;

            // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
            if (charts.radar) {
                charts.radar.destroy();
            }

            const labels = ['ğŸŒ… ì•„ì¹¨', 'â˜€ï¸ ì ì‹¬', 'ğŸŒ™ ì €ë…', 'ğŸ›Œ ìê¸°ì „'];
            const successRates = [];
            const totalCounts = [];

            for (let i = 1; i <= 4; i++) {
                const stat = reportData?.sensorStats?.[i];
                successRates.push(stat ? stat.successRate : 0);
                const maxCount = reportData?.totalDays || 30;
                totalCounts.push(stat ? Math.min(100, (stat.totalCount / maxCount) * 100) : 0);
            }

            charts.radar = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'ë³µìš© ì„±ê³µë¥  (%)',
                            data: successRates,
                            borderColor: 'rgba(107, 142, 107, 1)',
                            backgroundColor: 'rgba(107, 142, 107, 0.2)',
                            borderWidth: 3,
                            pointRadius: 6,
                            pointBackgroundColor: '#6B8E6B',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2
                        },
                        {
                            label: 'ë³µìš© ë¹ˆë„ (%)',
                            data: totalCounts,
                            borderColor: 'rgba(76, 175, 80, 1)',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            borderWidth: 2,
                            pointRadius: 5,
                            pointBackgroundColor: '#4CAF50'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 25,
                                font: { size: 10 }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            pointLabels: {
                                font: { size: 12 }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        // ì„¼ì„œ íƒ­ ì „í™˜
        function switchSensor(sensorId) {
            currentSensor = sensorId;

            // íƒ­ í™œì„±í™”
            document.querySelectorAll('.sensor-tab').forEach((tab, index) => {
                if (index === sensorId - 1) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            // ë¶„ì„ ë‚´ìš© ì—…ë°ì´íŠ¸
            updateSensorAnalysis(sensorId);
        }

        // ì„¼ì„œë³„ ìƒì„¸ ë¶„ì„ ì—…ë°ì´íŠ¸
        function updateSensorAnalysis(sensorId) {
            const sensor = sensorInfo[sensorId];
            const stat = reportData?.sensorStats?.[sensorId];

            // ì œëª© ì—…ë°ì´íŠ¸
            document.getElementById('selectedSensorEmoji').textContent = sensor.emoji;
            document.getElementById('selectedSensorName').textContent = sensor.name;

            // ë¶„ì„ ê°’ ì—…ë°ì´íŠ¸
            document.getElementById('analysisSuccessRate').textContent = `${stat?.successRate || 0}%`;
            document.getElementById('analysisTotalCount').textContent = `${stat?.totalCount || 0}íšŒ`;
            document.getElementById('analysisTargetTime').textContent = sensor.time;

            // ë¶„ì„ ì•„ì´í…œ ìƒ‰ìƒ ì—…ë°ì´íŠ¸
            const analysisItems = document.querySelectorAll('.analysis-item');
            analysisItems.forEach(item => {
                item.className = `analysis-item sensor-${sensorId}`;
            });

            // ì—°ì† ë³µìš© ì¼ìˆ˜
            if (reportData?.streakData) {
                document.getElementById('analysisStreak').textContent = 
                    `${reportData.streakData.currentStreaks?.[sensorId] || 0}ì¼`;
                document.getElementById('analysisMaxStreak').textContent = 
                    `${reportData.streakData.maxStreaks?.[sensorId] || 0}ì¼`;
            }

            // ì‹œê°„ëŒ€ë³„ ë¶„í¬ ì°¨íŠ¸ ì—…ë°ì´íŠ¸
            updateDistributionChart(sensorId);

            // ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼
            const analysisEl = document.getElementById('sensorAnalysis');
            analysisEl.classList.remove('slide-up');
            setTimeout(() => {
                analysisEl.classList.add('slide-up');
            }, 10);
        }

        // ì‹œê°„ëŒ€ë³„ ë¶„í¬ ì°¨íŠ¸
        function updateDistributionChart(sensorId) {
            const ctx = document.getElementById('distributionChart');
            if (!ctx) return;

            const stat = reportData?.sensorStats?.[sensorId];

            // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
            if (charts.distribution) {
                charts.distribution.destroy();
            }

            // ì‹œê°„ ë¼ë²¨ ìƒì„± (6ì‹œ~24ì‹œ, ì¤‘ìš” ì‹œê°„ëŒ€ë§Œ)
            const labels = ['6ì‹œ', '8ì‹œ', '10ì‹œ', '12ì‹œ', '14ì‹œ', '16ì‹œ', '18ì‹œ', '20ì‹œ', '22ì‹œ', '24ì‹œ'];
            const hours = [6, 8, 10, 12, 14, 16, 18, 20, 22, 24];

            // ë°ì´í„° ì¶”ì¶œ ë˜ëŠ” ê¸°ë³¸ê°’
            let data = new Array(10).fill(0);
            if (stat?.hourlyDistribution) {
                hours.forEach((hour, index) => {
                    data[index] = stat.hourlyDistribution[hour] || 0;
                });
            }

            const sensor = sensorInfo[sensorId];

            charts.distribution = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${sensor.name} ë³µìš© ì‹œê°„`,
                        data: data,
                        backgroundColor: sensor.color + '80',
                        borderColor: sensor.color,
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        // ì§„ë‹¨ ì¹´ë“œ ì—…ë°ì´íŠ¸
        function updateDiagnosisCards() {
            if (!reportData || !reportData.sensorStats) return;

            // ê°€ì¥ ì„±ê³µë¥ ì´ ë†’ì€/ë‚®ì€ ì„¼ì„œ ì°¾ê¸°
            let bestSensor = null;
            let bestRate = 0;
            let worstSensor = null;
            let worstRate = 100;

            for (let i = 1; i <= 4; i++) {
                const stat = reportData.sensorStats[i];
                if (stat) {
                    if (stat.successRate > bestRate) {
                        bestRate = stat.successRate;
                        bestSensor = { id: i, ...stat, ...sensorInfo[i] };
                    }
                    if (stat.successRate < worstRate) {
                        worstRate = stat.successRate;
                        worstSensor = { id: i, ...stat, ...sensorInfo[i] };
                    }
                }
            }

            // ì§„ë‹¨ ì¹´ë“œ 1: ìš°ìˆ˜í•œ ë³µì•½ ìŠµê´€
            const card1 = document.getElementById('diagnosisCard1');
            if (bestSensor && bestRate > 0) {
                if (bestRate >= 80) {
                    card1.className = 'diagnosis-card excellent';
                    card1.querySelector('.diagnosis-icon').textContent = 'ğŸ†';
                } else if (bestRate >= 50) {
                    card1.className = 'diagnosis-card good';
                    card1.querySelector('.diagnosis-icon').textContent = 'ğŸ‘';
                } else {
                    card1.className = 'diagnosis-card warning';
                    card1.querySelector('.diagnosis-icon').textContent = 'ğŸ’ª';
                }
                card1.querySelector('.diagnosis-title').textContent = 
                    bestRate >= 80 ? 'ìš°ìˆ˜í•œ ë³µì•½ ìŠµê´€' : 'ì„±ì¥ ì¤‘';
                card1.querySelector('.diagnosis-message').textContent = 
                    `${bestSensor.emoji} ${bestSensor.name} ë³µìš©ë¥ ì´ ${bestRate}%ë¡œ ê°€ì¥ ë†’ìŠµë‹ˆë‹¤!`;
            }

            // ì§„ë‹¨ ì¹´ë“œ 2: ì£¼ì˜ í•„ìš”
            const card2 = document.getElementById('diagnosisCard2');
            if (worstSensor && worstRate < 100) {
                if (worstRate < 30) {
                    card2.className = 'diagnosis-card danger';
                    card2.querySelector('.diagnosis-icon').textContent = 'ğŸš¨';
                    card2.querySelector('.diagnosis-title').textContent = 'ê¸´ê¸‰ ì£¼ì˜ í•„ìš”';
                } else if (worstRate < 60) {
                    card2.className = 'diagnosis-card warning';
                    card2.querySelector('.diagnosis-icon').textContent = 'âš ï¸';
                    card2.querySelector('.diagnosis-title').textContent = 'ì£¼ì˜ í•„ìš”';
                } else {
                    card2.className = 'diagnosis-card good';
                    card2.querySelector('.diagnosis-icon').textContent = 'ğŸ“Š';
                    card2.querySelector('.diagnosis-title').textContent = 'ê°œì„  ê°€ëŠ¥';
                }
                card2.querySelector('.diagnosis-message').textContent = 
                    `${worstSensor.emoji} ${worstSensor.name}(Sensor ${worstSensor.id})ì˜ ê°œë´‰ ë¹ˆë„ê°€ ${worstRate}%ì…ë‹ˆë‹¤.`;
            }

            // ì§„ë‹¨ ì¹´ë“œ 3: ì „ì²´ ìˆœì‘ë„
            const card3 = document.getElementById('diagnosisCard3');
            if (reportData.adherenceMetrics) {
                const overallRate = reportData.adherenceMetrics.overallAdherence || 0;
                if (overallRate >= 80) {
                    card3.className = 'diagnosis-card excellent';
                    card3.querySelector('.diagnosis-icon').textContent = 'ğŸ¯';
                    card3.querySelector('.diagnosis-title').textContent = 'í›Œë¥­í•œ ë³µì•½ ê´€ë¦¬';
                } else if (overallRate >= 60) {
                    card3.className = 'diagnosis-card good';
                    card3.querySelector('.diagnosis-icon').textContent = 'ğŸ“ˆ';
                    card3.querySelector('.diagnosis-title').textContent = 'ì–‘í˜¸í•œ ë³µì•½ ê´€ë¦¬';
                } else {
                    card3.className = 'diagnosis-card warning';
                    card3.querySelector('.diagnosis-icon').textContent = 'ğŸ“‰';
                    card3.querySelector('.diagnosis-title').textContent = 'ê°œì„  í•„ìš”';
                }
                card3.querySelector('.diagnosis-message').textContent = 
                    `ì „ì²´ ìˆœì‘ë„: ${overallRate}% (ëª©í‘œ: 80% ì´ìƒ)`;
            }
        }

        // AI ì¸ì‚¬ì´íŠ¸ ì—…ë°ì´íŠ¸
        function updateInsights() {
            if (!reportData || !reportData.sensorStats) return;

            const insights = [];

            // ì„¼ì„œë³„ ë¶„ì„
            for (let i = 1; i <= 4; i++) {
                const stat = reportData.sensorStats[i];
                const sensor = sensorInfo[i];
                
                if (stat) {
                    // ë‚®ì€ ë³µìš©ë¥  ê²½ê³ 
                    if (stat.successRate < 50 && stat.totalCount > 0) {
                        insights.push({
                            icon: 'âš ï¸',
                            text: `${sensor.emoji} ${sensor.name}ì˜ ë³µìš©ë¥ ì´ ${stat.successRate}%ë¡œ ë‚®ìŠµë‹ˆë‹¤. ì•Œë¦¼ ì„¤ì •ì„ í™•ì¸í•´ë³´ì„¸ìš”.`
                        });
                    }
                    
                    // ë†’ì€ ë³µìš©ë¥  ì¹­ì°¬
                    if (stat.successRate >= 90) {
                        insights.push({
                            icon: 'ğŸŒŸ',
                            text: `${sensor.emoji} ${sensor.name} ë³µìš©ì´ ë§¤ìš° ê·œì¹™ì ì…ë‹ˆë‹¤! ì´ íŒ¨í„´ì„ ìœ ì§€í•˜ì„¸ìš”.`
                        });
                    }
                }
            }

            // ì—°ì† ë³µìš© íŒ¨í„´
            if (reportData.streakData) {
                const currentStreaks = reportData.streakData.currentStreaks || {};
                const maxStreaks = reportData.streakData.maxStreaks || {};
                
                const bestCurrentStreak = Math.max(...Object.values(currentStreaks));
                const bestMaxStreak = Math.max(...Object.values(maxStreaks));
                
                if (bestCurrentStreak >= 7) {
                    insights.push({
                        icon: 'ğŸ”¥',
                        text: `í˜„ì¬ ${bestCurrentStreak}ì¼ ì—°ì† ë³µìš© ì¤‘ì…ë‹ˆë‹¤! í›Œë¥­í•œ ìŠµê´€ì„ ìœ ì§€í•˜ì„¸ìš”.`
                    });
                }
                
                if (bestMaxStreak >= 14 && bestCurrentStreak < bestMaxStreak) {
                    insights.push({
                        icon: 'ğŸ¯',
                        text: `ê³¼ê±° ìµœê³  ê¸°ë¡ì€ ${bestMaxStreak}ì¼ ì—°ì† ë³µìš©ì…ë‹ˆë‹¤. ë‹¤ì‹œ ë„ì „í•´ë³´ì„¸ìš”!`
                    });
                }
            }

            // ì „ì²´ ìˆœì‘ë„ ê¸°ë°˜ ì¡°ì–¸
            if (reportData.adherenceMetrics) {
                const overall = reportData.adherenceMetrics.overallAdherence || 0;
                if (overall < 70) {
                    insights.push({
                        icon: 'ğŸ’¡',
                        text: 'ì „ì²´ ë³µì•½ ìˆœì‘ë„ê°€ 70% ë¯¸ë§Œì…ë‹ˆë‹¤. ì •í•´ì§„ ì‹œê°„ì— ì•Œë¦¼ì„ ì„¤ì •í•´ë³´ì„¸ìš”.'
                    });
                }
            }

            // ê¸°ë³¸ ì¸ì‚¬ì´íŠ¸ê°€ ì—†ìœ¼ë©´ ì¶”ê°€
            if (insights.length === 0) {
                insights.push({
                    icon: 'ğŸ“Š',
                    text: 'ë³µì•½ ë°ì´í„°ê°€ ë” ìŒ“ì´ë©´ ê°œì¸í™”ëœ ì¸ì‚¬ì´íŠ¸ë¥¼ ì œê³µí•©ë‹ˆë‹¤.'
                });
                insights.push({
                    icon: 'â°',
                    text: 'ê° ì‹œê°„ëŒ€ë³„ ë³µì•½ íŒ¨í„´ì„ ë¶„ì„í•˜ì—¬ ìµœì ì˜ ì•Œë¦¼ ì‹œê°„ì„ ì œì•ˆí•©ë‹ˆë‹¤.'
                });
                insights.push({
                    icon: 'âœ¨',
                    text: 'ê¾¸ì¤€íˆ ì•½ì„ ë³µìš©í•˜ë©´ ê±´ê°• ê°œì„  íš¨ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!'
                });
            }

            // ì¸ì‚¬ì´íŠ¸ í‘œì‹œ
            const insightsList = document.getElementById('insightsList');
            insightsList.innerHTML = insights.slice(0, 5).map(insight => `
                <li class="insight-item">
                    <span class="insight-icon">${insight.icon}</span>
                    <span>${insight.text}</span>
                </li>
            `).join('');
        }

        // ë¦¬í¬íŠ¸ ìƒˆë¡œê³ ì¹¨
        function refreshReport() {
            // ë¡œë”© í‘œì‹œ
            const navItem = event?.target?.closest('.nav-item');
            if (navItem) {
                const icon = navItem.querySelector('.nav-icon');
                icon.style.animation = 'spin 1s linear infinite';
                
                setTimeout(() => {
                    icon.style.animation = '';
                }, 1000);
            }

            // ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
            loadReportData();
        }

        // ë¦¬í¬íŠ¸ ë‚´ë³´ë‚´ê¸°
        async function exportReport() {
            if (!reportData) {
                showToast('ë¦¬í¬íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                return;
            }

            try {
                // JSONìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°
                const exportData = {
                    exportDate: new Date().toISOString(),
                    reportType: 'monthly',
                    sensors: sensorInfo,
                    data: reportData
                };

                const blob = new Blob([JSON.stringify(exportData, null, 2)], 
                                     { type: 'application/json' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `coss-report-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                window.URL.revokeObjectURL(url);

                showToast('ë¦¬í¬íŠ¸ê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } catch (error) {
                console.error('Export failed:', error);
                showToast('ë¦¬í¬íŠ¸ ë‚´ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // í† ìŠ¤íŠ¸ ì•Œë¦¼
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ë¹ˆ ìƒíƒœ í‘œì‹œ
        function showEmptyState() {
            const mainContent = document.querySelector('.main-content');
            mainContent.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fa-solid fa-chart-line"></i>
                    </div>
                    <h3 class="empty-title">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
                    <p class="empty-description">
                        ë³µì•½ ë°ì´í„°ê°€ ì¶©ë¶„íˆ ìŒ“ì´ë©´<br>
                        ìƒì„¸í•œ ë¶„ì„ ë¦¬í¬íŠ¸ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </p>
                    <a href="/dashboard.html" class="empty-action">
                        ëŒ€ì‹œë³´ë“œë¡œ ì´ë™
                    </a>
                </div>
            `;
        }
    </script>
</body>
</html>
