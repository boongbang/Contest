<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>COSS Reports - 상세 통계</title>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background: #f0f2f5; margin: 0; padding: 20px 0; display: flex; justify-content: center; }
        .app-wrapper { width: 100%; max-width: 414px; background: #fff; min-height: 100vh; position: relative; }
        @media (min-width: 481px) { .app-wrapper { border-radius: 40px; min-height: 800px; box-shadow: 0 30px 60px rgba(0,0,0,0.1); overflow: hidden; } }
        
        .top-section { background: #6B8E6B; padding: 30px 25px 60px; color: #fff; border-bottom-right-radius: 70px; position: relative; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .main-title { font-family: 'Merriweather', serif; font-size: 2.5rem; line-height: 1.1; }
        .badges { position: absolute; bottom: -15px; left: 25px; display: flex; gap: 10px; }
        .badge { background: #000; color: #fff; padding: 5px 12px; border-radius: 15px; font-size: 0.8rem; font-weight: 600; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .badge.green { background: #4CAF50; }
        
        .bottom-section { padding: 40px 25px; }
        .chart-section { background: #fff; border-radius: 20px; padding: 20px; margin-bottom: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 1px solid #f0f0f0; }
        .chart-title { font-weight: 700; margin-bottom: 15px; color: #333; display: flex; align-items: center; gap: 8px; }
        .chart-container { height: 200px; position: relative; }
        
        .icon-btn { color: white; background: rgba(255,255,255,0.2); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; text-decoration: none; border: none; cursor: pointer; }
    </style>
</head>
<body>
    <div class="app-wrapper">
        <div class="top-section">
            <div class="header">
                <div><i class="fa-solid fa-pills"></i> COSS Report</div>
                <div style="display:flex; gap:10px">
                    <button class="icon-btn" onclick="location.reload()"><i class="fa-solid fa-rotate-right"></i></button>
                    <a href="/dashboard.html" class="icon-btn"><i class="fa-solid fa-house"></i></a>
                </div>
            </div>
            <h1 class="main-title">복약<br>분석</h1>
            <p>나의 건강 습관 리포트</p>
            <div class="badges">
                <div class="badge" id="totalBadge">0회</div>
                <div class="badge green" id="daysBadge">0일</div>
            </div>
        </div>

        <div class="bottom-section">
            <div class="chart-section">
                <div class="chart-title"><i class="fa-regular fa-clock"></i> 시간대별 복약 패턴</div>
                <div class="chart-container"><canvas id="hourlyChart"></canvas></div>
            </div>

            <div class="chart-section">
                <div class="chart-title"><i class="fa-regular fa-calendar-check"></i> 요일별 복약 현황</div>
                <div class="chart-container"><canvas id="weekdayChart"></canvas></div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin;
        let authToken = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');

        window.onload = async () => {
            if(!authToken) return window.location.href='/';
            await loadReportData();
        };

        async function loadReportData() {
            try {
                const res = await fetch(`${API_URL}/api/reports/detailed`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const data = await res.json();

                // 배지 업데이트
                const total = data.history.filter(h=>h.action==='removed').length;
                document.getElementById('totalBadge').textContent = `최근 ${total}회`;
                document.getElementById('daysBadge').textContent = `${data.totalDays}일 기록`;

                // [수정] 서버에서 받은 가공된 데이터(hourly, weekday)를 직접 사용
                drawChart('hourlyChart', 'line', data.hourly, ['0시','1시','2시','3시','4시','5시','6시','7시','8시','9시','10시','11시','12시','13시','14시','15시','16시','17시','18시','19시','20시','21시','22시','23시']);
                drawChart('weekdayChart', 'doughnut', data.weekday, ['일','월','화','수','목','금','토']);

            } catch(e) { console.error(e); }
        }

        function drawChart(id, type, data, labels) {
            new Chart(document.getElementById(id), {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        borderColor: '#6B8E6B',
                        backgroundColor: type==='line'?'rgba(107,142,107,0.2)' : ['#FFCDD2','#6B8E6B','#81C784','#AED581','#DCE775','#FFF176','#FFD54F'],
                        tension: 0.4, fill: true
                    }]
                },
                options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales: type==='line'?{y:{display:false},x:{grid:{display:false}}}:{} }
            });
        }
    </script>
</body>
</html>
